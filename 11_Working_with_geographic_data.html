<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Greg Ridgeway">
<meta name="dcterms.date" content="2025-09-21">

<title>Working with Geographic Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="11_Working_with_geographic_data_files/libs/clipboard/clipboard.min.js"></script>
<script src="11_Working_with_geographic_data_files/libs/quarto-html/quarto.js"></script>
<script src="11_Working_with_geographic_data_files/libs/quarto-html/popper.min.js"></script>
<script src="11_Working_with_geographic_data_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="11_Working_with_geographic_data_files/libs/quarto-html/anchor.min.js"></script>
<link href="11_Working_with_geographic_data_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="11_Working_with_geographic_data_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="11_Working_with_geographic_data_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="11_Working_with_geographic_data_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="11_Working_with_geographic_data_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="11_Working_with_geographic_data_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="11_Working_with_geographic_data_files/libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<style>
  pre code {
    white-space: pre-wrap;
    word-break: break-all;
    overflow-wrap: anywhere;
  }
</style>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#exploring-los-angeles-gang-injunction-maps" id="toc-exploring-los-angeles-gang-injunction-maps" class="nav-link" data-scroll-target="#exploring-los-angeles-gang-injunction-maps"><span class="header-section-number">2</span> Exploring Los Angeles gang injunction maps</a>
  <ul class="collapse">
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">2.1</span> Exercises</a></li>
  </ul></li>
  <li><a href="#using-tiger-files-from-the-us-census-to-merge-in-other-geographic-data" id="toc-using-tiger-files-from-the-us-census-to-merge-in-other-geographic-data" class="nav-link" data-scroll-target="#using-tiger-files-from-the-us-census-to-merge-in-other-geographic-data"><span class="header-section-number">3</span> Using TIGER files from the US Census to merge in other geographic data</a>
  <ul class="collapse">
  <li><a href="#transform-to-a-shared-coordinate-system" id="toc-transform-to-a-shared-coordinate-system" class="nav-link" data-scroll-target="#transform-to-a-shared-coordinate-system"><span class="header-section-number">3.1</span> Transform to a shared coordinate system</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise"><span class="header-section-number">3.2</span> Exercise</a></li>
  </ul></li>
  <li><a href="#merge-in-demographic-data-from-the-american-community-survey" id="toc-merge-in-demographic-data-from-the-american-community-survey" class="nav-link" data-scroll-target="#merge-in-demographic-data-from-the-american-community-survey"><span class="header-section-number">4</span> Merge in demographic data from the American Community Survey</a>
  <ul class="collapse">
  <li><a href="#exercise-1" id="toc-exercise-1" class="nav-link" data-scroll-target="#exercise-1"><span class="header-section-number">4.1</span> Exercise</a></li>
  </ul></li>
  <li><a href="#working-with-point-data-using-los-angeles-crime-data" id="toc-working-with-point-data-using-los-angeles-crime-data" class="nav-link" data-scroll-target="#working-with-point-data-using-los-angeles-crime-data"><span class="header-section-number">5</span> Working with point data using Los Angeles crime data</a>
  <ul class="collapse">
  <li><a href="#exercises-1" id="toc-exercises-1" class="nav-link" data-scroll-target="#exercises-1"><span class="header-section-number">5.1</span> Exercises</a></li>
  </ul></li>
  <li><a href="#creating-new-geographic-objects" id="toc-creating-new-geographic-objects" class="nav-link" data-scroll-target="#creating-new-geographic-objects"><span class="header-section-number">6</span> Creating new geographic objects</a></li>
  <li><a href="#overlaying-a-street-map" id="toc-overlaying-a-street-map" class="nav-link" data-scroll-target="#overlaying-a-street-map"><span class="header-section-number">7</span> Overlaying a street map</a>
  <ul class="collapse">
  <li><a href="#exercise-2" id="toc-exercise-2" class="nav-link" data-scroll-target="#exercise-2"><span class="header-section-number">7.1</span> Exercise</a></li>
  </ul></li>
  <li><a href="#find-which-line-is-closest-to-a-point" id="toc-find-which-line-is-closest-to-a-point" class="nav-link" data-scroll-target="#find-which-line-is-closest-to-a-point"><span class="header-section-number">8</span> Find which line is closest to a point</a>
  <ul class="collapse">
  <li><a href="#exercise-3" id="toc-exercise-3" class="nav-link" data-scroll-target="#exercise-3"><span class="header-section-number">8.1</span> Exercise</a></li>
  </ul></li>
  <li><a href="#make-a-kml-file-to-post-to-google-maps" id="toc-make-a-kml-file-to-post-to-google-maps" class="nav-link" data-scroll-target="#make-a-kml-file-to-post-to-google-maps"><span class="header-section-number">9</span> Make a KML file to post to Google Maps</a></li>
  <li><a href="#solutions-to-the-exercises" id="toc-solutions-to-the-exercises" class="nav-link" data-scroll-target="#solutions-to-the-exercises"><span class="header-section-number">10</span> Solutions to the exercises</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="11_Working_with_geographic_data.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Working with Geographic Data</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Greg Ridgeway <a href="mailto:gridge@upenn.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Pennsylvania
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 21, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<!-- In terminal -->
<!-- quarto render 11_Working_with_geographic_data.qmd -->
<!-- git commit 11_* -m "commit message" -->
<!-- git status -->
<!-- git push -->
<!-- A function for automating the numbering and wording of the exercise questions -->
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Geographic data includes</p>
<ul>
<li>point - crime locations, intersections, schools, transit stops</li>
<li>lines - roads, paths, routes</li>
<li>polygons - area within city boundaries, gang injunction safety zones, areas within 1000 ft of a school, census tracts</li>
</ul>
<p>Geographic data also include the data that go along with each of these shapes such as the area or length of the geographic object, the name of the object (e.g.&nbsp;City of Los Angeles), and other characteristics of the geography (e.g.&nbsp;population, date established).</p>
<p>Many questions about crime and the justice system involve the use of geographic data. In this section we will work toward answering questions about the race distribution of residents inside Los Angeles gang injunction zones, the number of crimes with 100 feet of Wilshire Blvd, and examine crimes near Metrorail stations.</p>
<p>We will be learning how to use the <code>sf</code> package for managing spatial data, the <code>tigris</code> package for obtaining TIGER files storing boundaries and roads, and <code>jsonlite</code> and <code>tidycensus</code> for pulling population data about residents in an area, like number of residents or race distribution.</p>
</section>
<section id="exploring-los-angeles-gang-injunction-maps" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Exploring Los Angeles gang injunction maps</h1>
<p>To start, along with our familiar data organizing packages, load the <code>sf</code> (simple features) package to get access to all the essential spatial tools. Also load the <code>lubridate</code> package since we will need to work with dates along the way.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr) <span class="co"># for set_names() and pluck()</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># for pivot_wider/pivot_longer</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All of the spatial functions in the <code>sf</code> package have a prefix <code>st_</code>(spatial/temporal). We will first read in <code>allinjunction.shp</code>, a shapefile containing the geographic definition of Los Angeles gang injunctions. You should have a collection of four files related to <code>allinjunctions</code>, a .dbf file, a .prj file, a .shx file, and a .shp file. even though the <code>st_read()</code> function appears to just ask for the .shp file, you need to have all four files in the same folder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"11_shapefiles_and_data/allinjunctions.shp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `allinjunctions' from data source 
  `C:\R4crim\11_shapefiles_and_data\allinjunctions.shp' using driver `ESRI Shapefile'
Simple feature collection with 65 features and 13 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 6378443 ymin: 1715015 xmax: 6511590 ymax: 1940541
Projected CRS: Lambert_Conformal_Conic</code></pre>
</div>
</div>
<p>Let’s take a look at what we have. <code>mapSZ</code> has a lot of data packed into it that we will explore. To make the plot we need to ask R to just extract the geometry.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>); <span class="fu">axis</span>(<span class="dv">2</span>); <span class="fu">box</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapGangInjunctions" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapGangInjunctions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapGangInjunctions-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapGangInjunctions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Map of Los Angeles gang injunctions
</figcaption>
</figure>
</div>
</div>
</div>
<p>I have added the x and y axis so that you note the scale. We can check the coordinate system for these data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(mapSZ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: Lambert_Conformal_Conic 
  wkt:
PROJCRS["Lambert_Conformal_Conic",
    BASEGEOGCRS["NAD83",
        DATUM["North American Datum 1983",
            ELLIPSOID["GRS 1980",6378137,298.257222101,
                LENGTHUNIT["metre",1]],
            ID["EPSG",6269]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["Degree",0.0174532925199433]]],
    CONVERSION["unnamed",
        METHOD["Lambert Conic Conformal (2SP)",
            ID["EPSG",9802]],
        PARAMETER["Latitude of false origin",33.5,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8821]],
        PARAMETER["Longitude of false origin",-118,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8822]],
        PARAMETER["Latitude of 1st standard parallel",34.0333333333333,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8823]],
        PARAMETER["Latitude of 2nd standard parallel",35.4666666666667,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8824]],
        PARAMETER["Easting at false origin",6561666.66666667,
            LENGTHUNIT["US survey foot",0.304800609601219],
            ID["EPSG",8826]],
        PARAMETER["Northing at false origin",1640416.66666667,
            LENGTHUNIT["US survey foot",0.304800609601219],
            ID["EPSG",8827]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["US survey foot",0.304800609601219,
                ID["EPSG",9003]]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["US survey foot",0.304800609601219,
                ID["EPSG",9003]]]]</code></pre>
</div>
</div>
<p>Of greatest importance is to notice that the projection is not latitude and longitude, although this is clearly the case from the previous plot. The coordinate system is the Lambert Conic Conformal (LCC) tuned specifically for the Los Angeles area. This coordinate system is oriented for the North American continental plate (NAD83), so precise that this coordinate system moves as the North America tectonic plate moves (2cm per year!). Also note that the unit of measurement is in feet. Whenever we compute a distance or area with these data, the units will be in feet or square feet. This projection is <a href="https://spatialreference.org/ref/epsg/2229/">EPSG 2229</a>, commonly called “California StatePlane Zone 5 (Los Angeles area), NAD83, US survey feet.” Curiously, the term “EPSG 2229” does not show up in this CRS. Whoever created the polygons in “allinjunctions.shp” included the mathematical description of the LCC projection, but not the EPSG tag. Very fixable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># only do this if you *know* for sure this is the right EPSG</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#    it does *not* transform one coordinate system to another</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(mapSZ) <span class="ot">&lt;-</span> <span class="dv">2229</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s examine the data attached to each polygon. Here are the first three rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 13 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 6378443 ymin: 1893403 xmax: 6438243 ymax: 1924413
Projected CRS: NAD83 / California zone 5 (ftUS)
       AREA PERIMETER GANG_INJ11 GANG_INJ_1 SHADESYM           NAME Inj_
1  18152790  17048.67          2          9        8       Foothill   09
2  11423653  20863.36          3          1      760 Langdon Street   04
3 129459650  54419.87          4         11      140    Canoga Park   11
   case_no      Safety_Zn    LAPD_Div      Pre_Date      Perm_Date
1 PC027254       Foothill    Foothill          &lt;NA&gt;  Aug. 22, 2001
2 LC048292 Langdon Street  Devonshire  May 20, 1999  Feb. 17, 2000
3 BC267153    Canoga Park West Valley Feb. 25, 2002 April 24, 2002
             gang_name                       geometry
1 Pacoima Project Boys POLYGON ((6435396 1924413, ...
2       Langdon Street POLYGON ((6418722 1908442, ...
3  Canoga Park Alabama POLYGON ((6379791 1908614, ...</code></pre>
</div>
</div>
<p>An <code>sf</code> object is really just a data frame with a special <code>geometry</code> column containing a description of the geographic object associated with that row. In this case we can see that each row is associated with a polygon. Each polygon in the map is associated with a specific gang injunction. The data attached to each polygon gives details about the associated injunction, such as the name of the injunction, in which LAPD division it is located, dates of the preliminary and permanent injunction, and the name of the gang that the injunction targets.</p>
<p>We can extract the coordinates of an injunction. Let’s grab the coordinates of the polygon for the first injunction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_coordinates</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            X       Y L1 L2
 [1,] 6435396 1924413  1  1
 [2,] 6435607 1924174  1  1
 [3,] 6435792 1923960  1  1
 [4,] 6435872 1923867  1  1
 [5,] 6436158 1923545  1  1
 [6,] 6436349 1923325  1  1
 [7,] 6437295 1922239  1  1
 [8,] 6438231 1921163  1  1
 [9,] 6438243 1921150  1  1
[10,] 6437992 1920931  1  1
[11,] 6437743 1920714  1  1
[12,] 6437495 1920498  1  1
[13,] 6437246 1920282  1  1
[14,] 6436874 1919958  1  1
[15,] 6436472 1919608  1  1
[16,] 6435940 1919144  1  1
[17,] 6435771 1918998  1  1
[18,] 6435633 1918878  1  1
[19,] 6435311 1918597  1  1
[20,] 6435143 1918451  1  1
[21,] 6435086 1918401  1  1
[22,] 6434689 1918857  1  1
[23,] 6434139 1919485  1  1
[24,] 6433857 1919808  1  1
[25,] 6433742 1919938  1  1
[26,] 6433189 1920572  1  1
[27,] 6433040 1920743  1  1
[28,] 6432908 1920894  1  1
[29,] 6432706 1921120  1  1
[30,] 6432500 1921348  1  1
[31,] 6432467 1921385  1  1
[32,] 6432279 1921596  1  1
[33,] 6432227 1921658  1  1
[34,] 6432296 1921718  1  1
[35,] 6432466 1921866  1  1
[36,] 6433399 1922679  1  1
[37,] 6433404 1922683  1  1
[38,] 6433857 1923073  1  1
[39,] 6434399 1923545  1  1
[40,] 6434790 1923885  1  1
[41,] 6434822 1923914  1  1
[42,] 6435396 1924413  1  1</code></pre>
</div>
</div>
<p>Let’s highlight the first injunction in our map. We can use <code>filter()</code> to select rows in <code>mapSZ</code> using any feature listed in <code>names(mapSZ)</code>. We will select it using its case number. Use <code>add=TRUE</code> to add the second plot to the first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(case_no<span class="sc">==</span><span class="st">"PC027254"</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"red"</span>, <span class="at">border=</span><span class="cn">NA</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapGangInjunctionsRedHighlight" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapGangInjunctionsRedHighlight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapGangInjunctionsRedHighlight-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapGangInjunctionsRedHighlight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Map of Los Angeles gang injunctions, PC027254 highlighted in red
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now we can see this tiny injunction shaded in red at the top of the map.</p>
<p>Turning back to the data attached to the map, we need to do some clean up on the dates. They are not in standard form and include a typo. We will fix the spelling error and use <code>lubridate</code> to standardize those dates. We will also add a <code>startDate</code> feature as the smaller of the preliminary injunction date and the permanent injunction date using the pairwise minimum function <code>pmin()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="ot">&lt;-</span> mapSZ <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">Pre_Date =</span> <span class="fu">gsub</span>(<span class="st">"Jne"</span>, <span class="st">"June"</span>, <span class="at">x=</span>Pre_Date) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">mdy</span>(),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">Perm_Date =</span> <span class="fu">mdy</span>(Perm_Date),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">startDate =</span> <span class="fu">pmin</span>(Pre_Date, Perm_Date, <span class="at">na.rm=</span><span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>   <span class="co"># some start dates I looked up in court records</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>   <span class="co">#   https://www.lacourt.ca.gov/pages/lp/access-a-case/tp/find-case-information/cp/os-civil-case-access</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">startDate=</span><span class="fu">case_match</span>(case_no,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"BC415694"</span> <span class="sc">~</span> <span class="fu">ymd</span>(<span class="st">"2009-06-12"</span>),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"BC435316"</span> <span class="sc">~</span> <span class="fu">ymd</span>(<span class="st">"2011-04-19"</span>),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"BC175684"</span> <span class="sc">~</span> <span class="fu">ymd</span>(<span class="st">"1998-11-10"</span>), <span class="co"># dismissed 2001/12/14</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"BC190334"</span> <span class="sc">~</span> <span class="fu">ymd</span>(<span class="st">"1998-05-01"</span>), <span class="co"># dismissed 2001/03/02</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"VC024170"</span> <span class="sc">~</span> <span class="cn">NA</span>, <span class="co"># never granted/enforced</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"BC399741"</span> <span class="sc">~</span> <span class="fu">ymd</span>(<span class="st">"2008-10-10"</span>),</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"BC187039"</span> <span class="sc">~</span> <span class="cn">NA</span>, <span class="co"># never granted</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">.default=</span>startDate))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s highlight the injunctions before 2000 in red, those between 2000 and 2010 in green, and those after 2010 in blue. Since many of the polygons overlap, we are going to make the colors a little transparent so that we can see the overlap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">cut</span>(<span class="fu">year</span>(startDate),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1999</span>, <span class="dv">2009</span>, <span class="cn">Inf</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"pre-2000"</span>,<span class="st">"2000s"</span>,<span class="st">"2010+"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(period) <span class="sc">|&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">pal =</span> <span class="fu">adjustcolor</span>(<span class="fu">c</span>(<span class="st">"red"</span>,<span class="st">"green"</span>,<span class="st">"blue"</span>), </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">alpha.f=</span><span class="fl">0.5</span>), <span class="co"># make a little transparent</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">border =</span> <span class="st">"black"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">main=</span><span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapGangInjunctionsByDecade" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapGangInjunctionsByDecade-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapGangInjunctionsByDecade-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapGangInjunctionsByDecade-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Map of Los Angeles gang injunctions. Those initiated prior to 2000 are in red, those initiatied between 2000 and 2010 are in green, and those initiated after 2010 are in blue
</figcaption>
</figure>
</div>
</div>
</div>
<p>When we loaded up the <code>sf</code> package, we also gained access to the GEOS library of geographic operations. For example, we can union (combine) all of the polygons together into one shape.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mapSZunion <span class="ot">&lt;-</span> <span class="fu">st_union</span>(mapSZ)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>mapSZunion <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapGangInjunctionsUnion" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapGangInjunctionsUnion-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapGangInjunctionsUnion-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapGangInjunctionsUnion-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Map of Los Angeles gang injunctions after applying <code>st_union()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Any overlapping injunctions have been combined into one polygon. <code>mapSZunion</code> now contains this unioned collection of polygons. Note that <code>mapSZunion</code> no longer has any data attached to it. Once we union polygons together, it is no longer obvious how to combine their associated data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mapSZunion</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 1 feature 
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 6378443 ymin: 1715015 xmax: 6511590 ymax: 1940541
Projected CRS: NAD83 / California zone 5 (ftUS)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>MULTIPOLYGON (((6457867 1818625, 6457867 181847...</code></pre>
</div>
</div>
<p>Let’s draw a polygon defining the area of Los Angeles that is within 1000 feet of an injunction. First, we will double check the units this map uses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check units</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(mapSZunion)<span class="sc">$</span>units</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "us-ft"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a buffer 1000 feet around the injunctions</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>mapSZ1000ft <span class="ot">&lt;-</span> mapSZunion <span class="sc">|&gt;</span> <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">1000</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>mapSZ1000ft <span class="sc">|&gt;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>mapSZunion <span class="sc">|&gt;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"red"</span>, <span class="at">border=</span><span class="cn">NA</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapGangInjunctionsUnion1000Buffer" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapGangInjunctionsUnion1000Buffer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapGangInjunctionsUnion1000Buffer-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapGangInjunctionsUnion1000Buffer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: A 1000-foot buffer around the Los Angeles gang injunctions
</figcaption>
</figure>
</div>
</div>
</div>
<p>Every injunction area is shaded red. The white bands between the red shapes and the black outlines is the 1000-foot buffer.</p>
<p>Previously we had to clean up some typos on the injunction dates data. The data can also have errors in the geography that requires fixing. Have a look at the MS13 gang injunction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="ot">&lt;-</span> mapSZ <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(case_no<span class="sc">==</span><span class="st">"BC311766"</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapGangInjunctionMS13" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapGangInjunctionMS13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapGangInjunctionMS13-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapGangInjunctionMS13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Map of MS13 gang injunction, Case BC311766
</figcaption>
</figure>
</div>
</div>
</div>
<p>The injunction has two mutually exclusive polygons that define the injunction. Both have strange artifacts. Examining the <code>mapSZms13</code> object, we can see that it has four polygons. Let’s color them so we can see which one is which. The ones with the smallest areas must be the artifacts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>mapSZms13</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 4 features and 14 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 6463941 ymin: 1841325 xmax: 6479076 ymax: 1858250
Projected CRS: NAD83 / California zone 5 (ftUS)
      AREA PERIMETER GANG_INJ11 GANG_INJ_1 SHADESYM                   NAME Inj_
1 70459367 34712.862         13          1        0 Rampart/East Hollywood   18
2  3452577  7902.383         14          1        0 Rampart/East Hollywood   18
3 49977447 32248.724         18          2        0 Rampart/East Hollywood   18
4  1403021  5211.601         22          2        0 Rampart/East Hollywood   18
   case_no                   Safety_Zn    LAPD_Div   Pre_Date  Perm_Date
1 BC311766 Rampart/East Hollywood (MS) Hwd/Wil/Rmp 2004-04-08 2004-05-10
2 BC311766 Rampart/East Hollywood (MS) Hwd/Wil/Rmp 2004-04-08 2004-05-10
3 BC311766 Rampart/East Hollywood (MS) Hwd/Wil/Rmp 2004-04-08 2004-05-10
4 BC311766 Rampart/East Hollywood (MS) Hwd/Wil/Rmp 2004-04-08 2004-05-10
         gang_name                       geometry  startDate
1 Mara Salvatrucha POLYGON ((6470191 1858229, ... 2004-04-08
2 Mara Salvatrucha POLYGON ((6465399 1858217, ... 2004-04-08
3 Mara Salvatrucha POLYGON ((6468057 1844983, ... 2004-04-08
4 Mara Salvatrucha POLYGON ((6477222 1841927, ... 2004-04-08</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rows 1 &amp; 3 seem to have the largest AREA</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(mapSZms13), </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">border =</span> <span class="fu">c</span>(<span class="st">"green"</span>,<span class="st">"red"</span>,<span class="st">"green"</span>,<span class="st">"blue"</span>),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">lwd    =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapGangInjunctionMS13artifactsColored" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapGangInjunctionMS13artifactsColored-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapGangInjunctionMS13artifactsColored-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapGangInjunctionMS13artifactsColored-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Map of MS13 gang injunction with artifacts highlighted
</figcaption>
</figure>
</div>
</div>
</div>
<p>The Los Angeles City Attorney’s Office had an <a href="11_shapefiles_and_data/Injunction-Map.pdf">injunction map</a> posted on its website that I have archived so we can see what the correct shape is supposed to be. Let’s clear out the weird artifacts to repair the gang injunction geometry. We can use <code>st_union()</code> to combine all the polygons together.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">st_union</span>(mapSZms13)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 1 feature 
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 6463941 ymin: 1841325 xmax: 6479076 ymax: 1858250
Projected CRS: NAD83 / California zone 5 (ftUS)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>MULTIPOLYGON (((6476845 1841356, 6476741 184141...</code></pre>
</div>
</div>
<p>Remember that <code>st_union()</code> will eliminate the associated data elements. Let’s borrow all the data from the first polygon, combine it with our unioned polygons, and use <code>st_sf()</code> to make a new simple features object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="ot">&lt;-</span> mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(NAME, case_no, Safety_Zn, gang_name, startDate) <span class="sc">|&gt;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_sf</span>(<span class="at">geometry=</span>a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s plot the final MS13 gang injunction safety zone and color in a 500-foot buffer around it. <code>st_difference()</code> computes the “difference” between two geometric objects. Here we take the polygon defined by being 500 feet out from the MS13 injunction area and “subtract” the injunction area leaving a sort of donut around the injunction area. You can safely ignore warnings about “attribute variables are assumed to be spatially constant throughout all geometries.” <code>st_difference()</code> assumes its result can inherit the data associated from the original objects used in the difference.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>mapSZmapBuf <span class="ot">&lt;-</span> mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_difference</span>(mapSZms13)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>mapSZmapBuf <span class="sc">|&gt;</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"green"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapMS13500buffer" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapMS13500buffer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapMS13500buffer-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapMS13500buffer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Map of MS13 gang injunction with a 500-foot buffer
</figcaption>
</figure>
</div>
</div>
</div>
<section id="exercises" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="exercises"><span class="header-section-number">2.1</span> Exercises</h2>
<ol type="1">
<li><p>Find the largest and smallest safety zones (use <code>st_area(mapSZ)</code>)</p></li>
<li><p>Plot all the safety zones. Color the largest in one color and the smallest in another color</p></li>
<li><p>Use <code>st_overlaps(mapSZ, mapSZ, sparse=FALSE)</code> or <code>print(st_overlaps(mapSZ, mapSZ, sparse=TRUE), n=Inf, max_nb=Inf)</code> to find two safety zones that overlap (not just touch at the edges)</p></li>
<li><p>With the two safety zones that you found in the previous question, plot using three different colors the first safety zone, second safety zone, and their intersection (hint: use <code>st_intersection()</code>)</p></li>
</ol>
</section>
</section>
<section id="using-tiger-files-from-the-us-census-to-merge-in-other-geographic-data" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Using TIGER files from the US Census to merge in other geographic data</h1>
<p>The US Census Bureau provides numerous useful geographic data files. We will use their TIGER files to get a map of the City of Los Angeles and we will get the census tracts that intersect with the city. Once you know an area’s census tract, you can obtain data on the population of the area. All of the TIGER files are available at <a href="https://www.census.gov/cgi-bin/geo/shapefiles/index.php">https://www.census.gov/cgi-bin/geo/shapefiles/index.php</a>.</p>
<p>First, we will extract an outline of the city. The file <code>tl_2019_06_place.shp</code> file is a TIGER line file, created in 2019, for state number 06 (California is 6th in alphabetical order), and contains all of the places (cities and towns). Here is the entire state.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>mapCAplaces <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"11_shapefiles_and_data/tl_2019_06_place.shp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `tl_2019_06_place' from data source 
  `C:\R4crim\11_shapefiles_and_data\tl_2019_06_place.shp' using driver `ESRI Shapefile'
Simple feature collection with 1521 features and 16 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -124.2695 ymin: 32.53433 xmax: -114.229 ymax: 41.99317
Geodetic CRS:  NAD83</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>mapCAplaces <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapCAplaces" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapCAplaces-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapCAplaces-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapCAplaces-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Map of all cities and towns in California
</figcaption>
</figure>
</div>
</div>
</div>
<p>The <code>tigris</code> package simplifies the process of navigating the Census website, locating the right shape files, and storing them in the right local folder. It will do all of those steps and load it into R as an <code>sf</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">tigris_use_cache =</span> <span class="cn">TRUE</span>) <span class="co"># avoids repeated downloads of same file</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>mapCAplaces <span class="ot">&lt;-</span> <span class="fu">places</span>(<span class="at">state=</span><span class="st">"CA"</span>, <span class="at">year=</span><span class="dv">2019</span>, <span class="at">class=</span><span class="st">"sf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And here is just the part of that shapefile containing Los Angeles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>mapLA <span class="ot">&lt;-</span> mapCAplaces <span class="sc">|&gt;</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(NAMELSAD<span class="sc">==</span><span class="st">"Los Angeles city"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>mapLA <span class="sc">|&gt;</span> </span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapLosAngeles" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapLosAngeles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapLosAngeles-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapLosAngeles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: Map of of the border of Los Angeles, California
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now let’s load in the census tracts for all of California.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># approach using tigris</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>mapCens <span class="ot">&lt;-</span> <span class="fu">tracts</span>(<span class="at">state=</span><span class="st">"CA"</span>, <span class="at">year=</span><span class="dv">2019</span>, <span class="at">class=</span><span class="st">"sf"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># or if you have it local</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="co"># mapCens &lt;- st_read("11_shapefiles_and_data/tl_2019_06_tract.shp")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>mapCens</code> contains polygons for all census tracts in California. That is a lot more than we need. We just need the ones that overlap with Los Angeles. <code>st_intersects()</code> can help us determine which census tracts are in Los Angeles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_intersects</span>(mapCens, mapLA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 8057, where the
predicate was `intersects'
first 10 elements:
 1: 1
 2: 1
 3: 1
 4: 1
 5: 1
 6: 1
 7: (empty)
 8: (empty)
 9: (empty)
 10: (empty)</code></pre>
</div>
</div>
<p>The resulting object has the same length as the number of census tracts in <code>mapCens</code>. The value of each component is the index of <code>st_intersects()</code> second argument that it intersects. In this example, <code>mapLA</code> is a single object so <code>st_intersects()</code> is either going to be a 1 or empty.</p>
<section id="transform-to-a-shared-coordinate-system" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="transform-to-a-shared-coordinate-system"><span class="header-section-number">3.1</span> Transform to a shared coordinate system</h2>
<p>Both <code>mapLA</code> and <code>mapCens</code> use the latitude/longitude coordinate system, which is not the same as the coordinate system we are using for the gang injunctions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(mapLA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: NAD83 
  wkt:
GEOGCRS["NAD83",
    DATUM["North American Datum 1983",
        ELLIPSOID["GRS 1980",6378137,298.257222101,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["latitude",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["longitude",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4269]]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(mapCens)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: NAD83 
  wkt:
GEOGCRS["NAD83",
    DATUM["North American Datum 1983",
        ELLIPSOID["GRS 1980",6378137,298.257222101,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["latitude",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["longitude",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4269]]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(mapSZ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coordinate Reference System:
  User input: EPSG:2229 
  wkt:
PROJCRS["NAD83 / California zone 5 (ftUS)",
    BASEGEOGCRS["NAD83",
        DATUM["North American Datum 1983",
            ELLIPSOID["GRS 1980",6378137,298.257222101,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4269]],
    CONVERSION["SPCS83 California zone 5 (US survey foot)",
        METHOD["Lambert Conic Conformal (2SP)",
            ID["EPSG",9802]],
        PARAMETER["Latitude of false origin",33.5,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8821]],
        PARAMETER["Longitude of false origin",-118,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8822]],
        PARAMETER["Latitude of 1st standard parallel",35.4666666666667,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8823]],
        PARAMETER["Latitude of 2nd standard parallel",34.0333333333333,
            ANGLEUNIT["degree",0.0174532925199433],
            ID["EPSG",8824]],
        PARAMETER["Easting at false origin",6561666.667,
            LENGTHUNIT["US survey foot",0.304800609601219],
            ID["EPSG",8826]],
        PARAMETER["Northing at false origin",1640416.667,
            LENGTHUNIT["US survey foot",0.304800609601219],
            ID["EPSG",8827]]],
    CS[Cartesian,2],
        AXIS["easting (X)",east,
            ORDER[1],
            LENGTHUNIT["US survey foot",0.304800609601219]],
        AXIS["northing (Y)",north,
            ORDER[2],
            LENGTHUNIT["US survey foot",0.304800609601219]],
    USAGE[
        SCOPE["Engineering survey, topographic mapping."],
        AREA["United States (USA) - California - counties Kern; Los Angeles; San Bernardino; San Luis Obispo; Santa Barbara; Ventura."],
        BBOX[32.76,-121.42,35.81,-114.12]],
    ID["EPSG",2229]]</code></pre>
</div>
</div>
<p>Furthermore, <code>st_intersects()</code> and most other geographic functions do not work well, with latitude and longitude. We should really work with all of our spatial objects having the same projection. We can transform <code>mapLA</code> and <code>mapCens</code> to have the same coordinate system as our injunction area map, <code>mapSZ</code>, which uses a projection (LCC) different from latitude/longitude.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>mapCens <span class="ot">&lt;-</span> mapCens <span class="sc">|&gt;</span> <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="fu">st_crs</span>(mapSZ))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>mapLA   <span class="ot">&lt;-</span> mapLA   <span class="sc">|&gt;</span> <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="fu">st_crs</span>(mapSZ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can ask R to tell us for each census tract whether or not it intersects with the Los Angeles map. The result of <code>st_intersects()</code> is a list where <code>a[[1]]</code> will tell us which of the polygons in <code>mapLA</code> intersects with the first polygon in <code>mapCens</code>. Again, since <code>mapLA</code> only has one polygon, <code>a[[1]]</code> will either be empty or 1. Therefore, to create an indicator of intersecting Los Angeles we just need to know whether the length of each element of <code>a</code> exceeds 0 (is not empty). We will create a new column in the <code>mapCens</code> data containing a <code>TRUE</code>/<code>FALSE</code> indicator of whether that census tract is in Los Angeles or not.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> mapCens <span class="sc">|&gt;</span> <span class="fu">st_intersects</span>(mapLA)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># length equals the number of census tracts</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(a) <span class="sc">==</span> <span class="fu">nrow</span>(mapCens)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># lengths() asks every component of a how many elements they contain</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>mapCens<span class="sc">$</span>inLA <span class="ot">&lt;-</span> <span class="fu">lengths</span>(a) <span class="sc">&gt;</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Equivalently, we could have asked <code>st_intersects()</code> to create a list of census tracts that intersect with <code>mapLA</code>, by reversing <code>mapLA</code> and <code>mapCens</code> in <code>st_intersects()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(mapLA, mapCens)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># should equal 1, there's only one shape in mapLA</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(a)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save the indices of census tracts that intersect with mapLA</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>iLAtracts <span class="ot">&lt;-</span> a <span class="sc">|&gt;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unlist</span>()</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>iLAtracts <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">10</span>) <span class="co"># print out the first 10 to check</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  1  2  3  4  5  6 17 18 19 20</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>mapCens <span class="ot">&lt;-</span> mapCens <span class="sc">|&gt;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">inLA =</span> (<span class="fu">row_number</span>() <span class="sc">%in%</span> iLAtracts))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check that the census tracts with <code>TRUE</code> for <code>inLA</code> actually intersect Los Angeles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>mapCens <span class="ot">&lt;-</span> mapCens <span class="sc">|&gt;</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inLA)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>mapCens <span class="sc">|&gt;</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>mapLA <span class="sc">|&gt;</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">border=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapLAtracts" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapLAtracts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapLAtracts-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapLAtracts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Map of all census tracts that overlap Los Angeles
</figcaption>
</figure>
</div>
</div>
</div>
<p>Which census tracts cover the MS13 safety zone?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_intersects</span>(mapSZms13, mapCens)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 1, where the predicate
was `intersects'
 1: 18, 95, 101, 102, 103, 110, 133, 141, 165, 199, ...</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> mapSZms13 <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersects</span>(mapCens) <span class="sc">|&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unlist</span>()</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>mapCens <span class="ot">&lt;-</span> mapCens <span class="sc">|&gt;</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">inMS13 =</span> (<span class="fu">row_number</span>() <span class="sc">%in%</span> a))</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>mapCens <span class="sc">|&gt;</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inMS13) <span class="sc">|&gt;</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-mapMS13tracts" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapMS13tracts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-mapMS13tracts-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapMS13tracts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: Map of all census tracts that overlap the MS13 injunction
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="exercise" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="exercise"><span class="header-section-number">3.2</span> Exercise</h2>
<ol start="5" type="1">
<li>Census tracts that just touch the boundary of the safety zone are included. To eliminate, rather than use <code>st_intersects()</code> with <code>mapSZms13</code>, use <code>st_intersects()</code> with <code>st_buffer()</code> with a negative <code>dist</code> to select census tracts</li>
</ol>
</section>
</section>
<section id="merge-in-demographic-data-from-the-american-community-survey" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Merge in demographic data from the American Community Survey</h1>
<p>The full census of the United States occurs every ten years, but in between those surveys the Census Bureau collects data through the American Community Survey (ACS) by selecting a sample of households. These surveys have a lot of information about people and neighborhoods. We are going to use the ACS to gather race data on the residents within census tracts.</p>
<p>JSON (JavaScript Object Notation) is a very common protocol for moving data. The ACS provides JSON access to its data. There are other ways of accessing ACS data, like downloading the entire ACS dataset, but we are going to use JSON so that you become familiar with how JSON works. Also, when we only need a small amount of information (just race data from particular census tracts) it can save a lot of effort when compared with downloading and processing the full ACS dataset.</p>
<p>First, let’s load the <code>jsonlite</code> library.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is how you can access the ACS data on the total population of the United States in 2010</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fromJSON</span>(<span class="st">"https://api.census.gov/data/2010/acs/acs5?get=NAME,B01001_001E&amp;for=us:*"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]            [,2]          [,3]
[1,] "NAME"          "B01001_001E" "us"
[2,] "United States" "303965272"   "1" </code></pre>
</div>
</div>
<p>Let’s deconstruct this URL. First, we are accessing data from the 2010 ACS data using <code>https://api.census.gov/data/2010/acs/</code>. Second, we are using the data from the ACS sample collected over the last five years to estimate the total population… that is the <code>acs5</code> part. Third, we are accessing variable <code>B01001_001E</code>, which contains an estimate (the E at the end is for estimate) of the number of people in the United States. This we needed to track down, but the <a href="https://find.library.upenn.edu/catalog/9941110333503681?hld_id=61468399770003681">Social Explorer website</a> makes this easier. Navigate to Social Explorer through the Penn Library to gain full access. Lastly, we asked <code>for=us:*</code>, meaning for the entire United States.</p>
<p>If we want the total number of people in specific census tracts, then we can make this request.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fromJSON</span>(<span class="st">"https://api.census.gov/data/2010/acs/acs5?get=B01001_001E&amp;for=tract:204920,205110&amp;in=state:06+county:037"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]          [,2]    [,3]     [,4]    
[1,] "B01001_001E" "state" "county" "tract" 
[2,] "2483"        "06"    "037"    "204920"
[3,] "3865"        "06"    "037"    "205110"</code></pre>
</div>
</div>
<p>Here we have requested population data (variable <code>B01001_001E</code>) for two specific census tracts (204920 and 205110) from California (state 06) in Los Angeles County (county 037).</p>
<p>If we want the total population in each tract in Los Angeles County, just change the tract list to an *.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fromJSON</span>(<span class="st">"https://api.census.gov/data/2010/acs/acs5?get=B01001_001E&amp;for=tract:*&amp;in=state:06+county:037"</span>) <span class="sc">|&gt;</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>   <span class="co"># over 2000 census tracts in LA County... show  first 10</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1]          [,2]    [,3]     [,4]    
[1,] "B01001_001E" "state" "county" "tract" 
[2,] "4493"        "06"    "037"    "141400"
[3,] "2715"        "06"    "037"    "141500"
[4,] "3693"        "06"    "037"    "141600"
[5,] "3002"        "06"    "037"    "141700"
[6,] "3900"        "06"    "037"    "143100"</code></pre>
</div>
</div>
<p>Many more examples are posted at the <a href="https://api.census.gov/data/2010/acs/acs5/examples.html">Census API website</a>.</p>
<p>Now let’s get something more complete that we can merge into our geographic data. For each census tract in Los Angeles County, we will extract the total population (<code>B03002001</code>), the number of non-Hispanic white residents (<code>B03002003</code>), non-Hispanic black residents (<code>B03002004</code>), and Hispanic residents (<code>B03002012</code>).</p>
<p>We could craft a JSON query to pull these data. However, the <code>tidycensus</code> package provides a handy set of tools that wrap around these JSON API calls. If you expect to hit the Census API a lot, then you need to create an account and get a Census API key. For the volume of requests we will do here (less than 500 per day), it is not necessary. Here we get ACS data on race using <code>get_acs()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidycensus)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>dataRace <span class="ot">&lt;-</span> </span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">get_acs</span>(<span class="at">geography =</span> <span class="st">"tract"</span>,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"B03002_001E"</span>,<span class="st">"B03002_003E"</span>,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"B03002_004E"</span>,<span class="st">"B03002_012E"</span>),</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">state     =</span> <span class="st">"CA"</span>,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">county    =</span> <span class="st">"Los Angeles"</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">year      =</span> <span class="dv">2010</span>,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">survey    =</span> <span class="st">"acs5"</span>,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">cache_table =</span> <span class="cn">TRUE</span>,</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">show_call =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Getting data from the 2006-2010 5-year ACS</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: • You have not set a Census API key. Users without a key are limited to 500
queries per day and may experience performance limitations.
ℹ For best results, get a Census API key at
http://api.census.gov/data/key_signup.html and then supply the key to the
`census_api_key()` function to use it throughout your tidycensus session.
This warning is displayed once per session.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Census API call: https://api.census.gov/data/2010/acs/acs5?get=B03002_001E%2CB03002_001M%2CB03002_003E%2CB03002_003M%2CB03002_004E%2CB03002_004M%2CB03002_012E%2CB03002_012M%2CNAME&amp;for=tract%3A%2A&amp;in=state%3A06%2Bcounty%3A037</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>dataRace</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,384 × 5
   GEOID       NAME                                      variable estimate   moe
   &lt;chr&gt;       &lt;chr&gt;                                     &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
 1 06037101110 Census Tract 1011.10, Los Angeles County… B03002_…     5017   362
 2 06037101110 Census Tract 1011.10, Los Angeles County… B03002_…     3248   466
 3 06037101110 Census Tract 1011.10, Los Angeles County… B03002_…       38    41
 4 06037101110 Census Tract 1011.10, Los Angeles County… B03002_…     1085   390
 5 06037101122 Census Tract 1011.22, Los Angeles County… B03002_…     3663   287
 6 06037101122 Census Tract 1011.22, Los Angeles County… B03002_…     2426   286
 7 06037101122 Census Tract 1011.22, Los Angeles County… B03002_…        0   132
 8 06037101122 Census Tract 1011.22, Los Angeles County… B03002_…      451   167
 9 06037101210 Census Tract 1012.10, Los Angeles County… B03002_…     6799   575
10 06037101210 Census Tract 1012.10, Los Angeles County… B03002_…     3235   529
# ℹ 9,374 more rows</code></pre>
</div>
</div>
<p>With <code>show_call = TRUE</code> I have asked <code>get_acs()</code> to reveal the JSON query it used to fetch the data. For each census tract/variable combination we have an estimate and its margin of error. Let’s clean this up, give clearer race labels, and pivot to create one row per census tract.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>dataRace <span class="ot">&lt;-</span> dataRace <span class="sc">|&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(GEOID, variable, estimate) <span class="sc">|&gt;</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">race =</span> <span class="fu">case_match</span>(variable,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">"B03002_001"</span> <span class="sc">~</span> <span class="st">"total"</span>,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">"B03002_003"</span> <span class="sc">~</span> <span class="st">"white"</span>,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>               <span class="st">"B03002_004"</span> <span class="sc">~</span> <span class="st">"black"</span>,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>               <span class="st">"B03002_012"</span> <span class="sc">~</span> <span class="st">"hisp"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span>variable) <span class="sc">|&gt;</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> race,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_from =</span> estimate,</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">other =</span> total<span class="sc">-</span>white<span class="sc">-</span>black<span class="sc">-</span>hisp)</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>dataRace</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,346 × 6
   GEOID       total white black  hisp other
   &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 06037101110  5017  3248    38  1085   646
 2 06037101122  3663  2426     0   451   786
 3 06037101210  6799  3235   252  2790   522
 4 06037101220  3189  1768    23  1148   250
 5 06037101300  3808  3121    12   423   252
 6 06037101400  3733  2868   132   406   327
 7 06037102103  1841  1264    39   298   240
 8 06037102104  3695  2763    32   550   350
 9 06037102105  1525   166     0  1193   166
10 06037102107  3503  2332    40   826   305
# ℹ 2,336 more rows</code></pre>
</div>
</div>
<p>Now we have a data frame that links the census tract numbers to populations and race data. Let’s add race information to the MS13 injunction data. And since we have been using a lot of base R’s plotting functions, to change things up let’s create a <code>ggplot</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co"># match tract IDs and merge in % hispanic</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>mapCens <span class="sc">|&gt;</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>   <span class="co"># merge in race data</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(dataRace, <span class="fu">join_by</span>(GEOID<span class="sc">==</span>GEOID)) <span class="sc">|&gt;</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">pctHisp =</span> <span class="fu">if_else</span>(total<span class="sc">&gt;</span><span class="dv">0</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(hisp), hisp<span class="sc">/</span>total, <span class="dv">0</span>),</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>          <span class="co"># choose a shade of gray</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">colGray =</span> <span class="fu">gray</span>(pctHisp),</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>          <span class="co"># nicely formatted percentages</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">pctHispLabel =</span> scales<span class="sc">::</span><span class="fu">percent</span>(pctHisp, <span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inMS13) <span class="sc">|&gt;</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> colGray), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_sf</span>(<span class="at">data=</span>mapSZms13, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">fill=</span><span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>   <span class="co"># tells ggplot fill has actual color values</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>   <span class="fu">scale_fill_identity</span>() <span class="sc">+</span> </span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_sf_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> pctHispLabel),</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>                <span class="co"># function giving where to place label</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">fun.geometry =</span> st_point_on_surface,</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">size =</span> <span class="dv">3</span>, </span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>                <span class="co"># text that overlaps previous text not plotted</span></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">check_overlap =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ggplotMS13PctHisp" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ggplotMS13PctHisp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-ggplotMS13PctHisp-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ggplotMS13PctHisp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Percentage of Hispanic residents in census tracts overlapping the MS13 gang injunction safety zones
</figcaption>
</figure>
</div>
</div>
</div>
<section id="exercise-1" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="exercise-1"><span class="header-section-number">4.1</span> Exercise</h2>
<ol start="6" type="1">
<li><p>Create a map of all census tracts in the City of Los Angeles within 1 mile of one of the safety zones (you choose which safety zone)</p></li>
<li><p>Color each area based on a census feature (e.g.&nbsp;% non-white, or some other feature from the ACS data)</p></li>
<li><p>Add the polygon with your injunction zone</p></li>
<li><p>Add other injunction zones that intersect with your map</p></li>
</ol>
</section>
</section>
<section id="working-with-point-data-using-los-angeles-crime-data" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Working with point data using Los Angeles crime data</h1>
<p>The Los Angeles Police Department (LAPD) posts all of its crime data at Los Angeles’ open data portal. We are interested in the 2010-2019 crime data held in the <a href="https://data.lacity.org/Public-Safety/Crime-Data-from-2010-to-2019/63jg-8b9z">2010-2019 crime data file</a>. We are also interested in the crime data for <a href="https://data.lacity.org/Public-Safety/Crime-Data-from-2020-to-Present/2nrs-mtv8">2020 to the present</a>, which LAPD posts separately.</p>
<p>There are several ways we could go about retrieving the data. One method is to ask R to download the data to our computer and then use <code>read.csv()</code> to import it. Conveniently, the Los Angeles open data portal allows “SoQL” queries, meaning that we can use SQL-like where clauses. By default, SoQL will limit the result to 1,000 rows, so I have modified the limit to 5 million, more than enough to get all the 2019 crime data. Here I demonstrate retrieving just the 2019 crime incidents.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method #1</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"11_shapefiles_and_data/LAPD crime data 2019.csv"</span>))</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">download.file</span>(<span class="st">"https://data.lacity.org/resource/63jg-8b9z.csv?$where=date_extract_y(date_occ)=2019&amp;$limit=5000000"</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">destfile =</span> <span class="st">"11_shapefiles_and_data/LAPD crime data 2019.csv"</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>dataCrime <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"11_shapefiles_and_data/LAPD crime data 2019.csv"</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">as.is=</span><span class="cn">TRUE</span>)</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="co"># check data range</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(dataCrime<span class="sc">$</span>date_occ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2019-01-01T00:00:00.000" "2019-12-31T00:00:00.000"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check number of rows and columns</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(dataCrime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 218918     28</code></pre>
</div>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check first few rows</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dataCrime, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      dr_no               date_rptd                date_occ time_occ area
1 191907191 2019-03-11T00:00:00.000 2019-03-08T00:00:00.000     1500   19
2 192015710 2019-08-24T00:00:00.000 2019-08-23T00:00:00.000      537   20
3 191417298 2019-08-01T00:00:00.000 2019-07-26T00:00:00.000     1000   14
  area_name rpt_dist_no part_1_2 crm_cd      crm_cd_desc mocodes vict_age
1   Mission        1918        1    510 VEHICLE - STOLEN                0
2   Olympic        2005        1    648            ARSON               50
3   Pacific        1427        1    510 VEHICLE - STOLEN                0
  vict_sex vict_descent premis_cd premis_desc weapon_used_cd weapon_desc status
1                             101      STREET             NA                 IC
2        M            H       101      STREET             NA                 IC
3                             101      STREET             NA                 IC
  status_desc crm_cd_1 crm_cd_2 crm_cd_3 crm_cd_4
1 Invest Cont      510       NA       NA       NA
2 Invest Cont      648       NA       NA       NA
3 Invest Cont      510       NA       NA       NA
                                  location cross_street     lat       lon
1 13200    FOOTHILL                     BL              34.2991 -118.4211
2   400 N  NORMANDIE                    AV              34.0799 -118.3025
3  3100 S  SEPULVEDA                    BL              34.0265 -118.4279</code></pre>
</div>
</div>
<p>Alternatively, we can just skip the download and ask R to directly read in the data from the Los Angeles data portal. The only downside to this is if you mess up your data, then you will need to download it all over again, which can be slow.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method #2</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>dataCrime <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://data.lacity.org/resource/63jg-8b9z.csv?$where=date_extract_y(date_occ)=2019&amp;$limit=5000000"</span>,</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">as.is=</span><span class="cn">TRUE</span>) <span class="co"># don't convert strings to other types (e.g. logical)</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># check data range</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(dataCrime<span class="sc">$</span>date_occ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2019-01-01T00:00:00.000" "2019-12-31T00:00:00.000"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check number of rows and columns</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(dataCrime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 218918     28</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check first few rows</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dataCrime, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      dr_no               date_rptd                date_occ time_occ area
1 191907191 2019-03-11T00:00:00.000 2019-03-08T00:00:00.000     1500   19
2 192015710 2019-08-24T00:00:00.000 2019-08-23T00:00:00.000      537   20
3 191417298 2019-08-01T00:00:00.000 2019-07-26T00:00:00.000     1000   14
  area_name rpt_dist_no part_1_2 crm_cd      crm_cd_desc mocodes vict_age
1   Mission        1918        1    510 VEHICLE - STOLEN                0
2   Olympic        2005        1    648            ARSON               50
3   Pacific        1427        1    510 VEHICLE - STOLEN                0
  vict_sex vict_descent premis_cd premis_desc weapon_used_cd weapon_desc status
1                             101      STREET             NA                 IC
2        M            H       101      STREET             NA                 IC
3                             101      STREET             NA                 IC
  status_desc crm_cd_1 crm_cd_2 crm_cd_3 crm_cd_4
1 Invest Cont      510       NA       NA       NA
2 Invest Cont      648       NA       NA       NA
3 Invest Cont      510       NA       NA       NA
                                  location cross_street     lat       lon
1 13200    FOOTHILL                     BL              34.2991 -118.4211
2   400 N  NORMANDIE                    AV              34.0799 -118.3025
3  3100 S  SEPULVEDA                    BL              34.0265 -118.4279</code></pre>
</div>
</div>
<p>Let’s download all 2010-2019 data as well as the 2020-present data so that we can explore changes in crime over time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the 2010-2019 data</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">timeout =</span> <span class="dv">600</span>) <span class="co"># ten minutes</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"11_shapefiles_and_data/LAPD crime data 2010-2019.csv"</span>))</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">download.file</span>(<span class="st">"https://data.lacity.org/resource/63jg-8b9z.csv?$limit=5000000"</span>,</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">destfile =</span> <span class="st">"11_shapefiles_and_data/LAPD crime data 2010-2019.csv"</span>,</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="co"># get the 2020-present data</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"11_shapefiles_and_data/LAPD crime data 2020-present.csv"</span>))</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">download.file</span>(<span class="st">"https://data.lacity.org/resource/2nrs-mtv8.csv?$limit=5000000"</span>,</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">destfile =</span> <span class="st">"11_shapefiles_and_data/LAPD crime data 2020-present.csv"</span>,</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>                 <span class="at">quiet=</span><span class="cn">TRUE</span>)</span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="co"># combine 2010-2019 data and 2020-present data</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>dataCrime <span class="ot">&lt;-</span> </span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">read.csv</span>(<span class="st">"11_shapefiles_and_data/LAPD crime data 2010-2019.csv"</span>,</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">as.is=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>   <span class="fu">bind_rows</span>(<span class="fu">read.csv</span>(<span class="st">"11_shapefiles_and_data/LAPD crime data 2020-present.csv"</span>,</span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">as.is=</span><span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Like always, let’s check the size and peek at the first three rows to see what we have.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(dataCrime)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3138128</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>dataCrime <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     dr_no               date_rptd                date_occ time_occ area
1  1307355 2010-02-20T00:00:00.000 2010-02-20T00:00:00.000     1350   13
2 11401303 2010-09-13T00:00:00.000 2010-09-12T00:00:00.000       45   14
3 70309629 2010-08-09T00:00:00.000 2010-08-09T00:00:00.000     1515   13
  area_name rpt_dist_no part_1_2 crm_cd
1    Newton        1385        2    900
2   Pacific        1485        2    740
3    Newton        1324        2    946
                                              crm_cd_desc        mocodes
1                                VIOLATION OF COURT ORDER 0913 1814 2000
2 VANDALISM - FELONY ($400 &amp; OVER, ALL CHURCH VANDALISMS)           0329
3                               OTHER MISCELLANEOUS CRIME           0344
  vict_age vict_sex vict_descent premis_cd            premis_desc
1       48        M            H       501 SINGLE FAMILY DWELLING
2        0        M            W       101                 STREET
3        0        M            H       103                  ALLEY
  weapon_used_cd weapon_desc status  status_desc crm_cd_1 crm_cd_2 crm_cd_3
1             NA                 AA Adult Arrest      900       NA       NA
2             NA                 IC  Invest Cont      740       NA       NA
3             NA                 IC  Invest Cont      946       NA       NA
  crm_cd_4                                location
1       NA  300 E  GAGE                         AV
2       NA         SEPULVEDA                    BL
3       NA 1300 E  21ST                         ST
                     cross_street     lat       lon
1                                 33.9825 -118.2695
2 MANCHESTER                   AV 33.9599 -118.3962
3                                 34.0224 -118.2524</code></pre>
</div>
</div>
<p>It is also a good idea to check counts over time and over places. Note that there are some strange anomolies, like areas 19, 20, 21 in 2015 followed by very large jumps in 2016. Looks like 2015 and 2016 data were miscoded for these areas in these years.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>dataCrime <span class="sc">|&gt;</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">count</span>(<span class="at">year=</span><span class="fu">year</span>(<span class="fu">mdy_hms</span>(date_occ)),area) <span class="sc">|&gt;</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">pivot_wider</span>(<span class="at">names_from=</span>year,<span class="at">values_from=</span>n) <span class="sc">|&gt;</span> </span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span>(<span class="at">n=</span><span class="cn">Inf</span>, <span class="at">width=</span><span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `count()`.
ℹ In argument: `year = year(mdy_hms(date_occ))`.
Caused by warning:
! All formats failed to parse. No formats found.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 × 2
    area   `NA`
   &lt;int&gt;  &lt;int&gt;
 1     1 168167
 2     2 136760
 3     3 193270
 4     4 115355
 5     5 133675
 6     6 151759
 7     7 137161
 8     8 134966
 9     9 143010
10    10 132140
11    11 143512
12    12 207568
13    13 149539
14    14 172320
15    15 165409
16    16 113375
17    17 145263
18    18 163048
19    19 144826
20    20 146534
21    21 140471</code></pre>
</div>
</div>
<p>Now keep incidents that are not missing the latitude or longitude, are not on the equator (0,0), and convert the data frame into a simple features spatial object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>dataCrime <span class="ot">&lt;-</span> dataCrime <span class="sc">|&gt;</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(lat) <span class="sc">&amp;</span> lat <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> </span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>          <span class="sc">!</span><span class="fu">is.na</span>(lon) <span class="sc">&amp;</span> lon <span class="sc">&lt;</span> <span class="dv">0</span> ) <span class="sc">|&gt;</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">"lon"</span>,<span class="st">"lat"</span>),</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">crs=</span><span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Setting <code>crs=4326</code> tells R that this spatial object has coordinates in latitude and longitude. Remember that <a href="http://www.spatialreference.org/ref/epsg/4326/">EPSG 4326</a> refers to latitude and longitude.</p>
<p>Now we need to reproject the data into the coordinate system to match the injunction safety zone map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>dataCrime <span class="ot">&lt;-</span> dataCrime <span class="sc">|&gt;</span> </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(mapSZms13))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s now identify which crimes occurred within one mile of the MS13 injunction. I did some checking and noted that LAPD areas 1, 2, 3, 6, 7, 11, and 20 intersected with the MS13 safety zone, so I picked out just those crimes and plotted them each in different colors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>mapMS13mileBuffer <span class="ot">&lt;-</span> mapSZms13 <span class="sc">|&gt;</span> <span class="fu">st_buffer</span>(<span class="dv">5280</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>bboxMS13 <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(mapMS13mileBuffer)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>(<span class="at">data =</span> dataCrime <span class="sc">|&gt;</span> </span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">filter</span>(area <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">11</span>,<span class="dv">20</span>)) <span class="sc">|&gt;</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">mutate</span>(<span class="at">X =</span> <span class="fu">st_coordinates</span>(geometry)[,<span class="st">"X"</span>],</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Y =</span> <span class="fu">st_coordinates</span>(geometry)[,<span class="st">"Y"</span>]) <span class="sc">|&gt;</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">select</span>(X, Y, area) <span class="sc">|&gt;</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">filter</span>(X<span class="sc">&gt;</span>bboxMS13[<span class="st">"xmin"</span>] <span class="sc">&amp;</span> X<span class="sc">&lt;</span>bboxMS13[<span class="st">"xmax"</span>] <span class="sc">&amp;</span> </span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>                        Y<span class="sc">&gt;</span>bboxMS13[<span class="st">"ymin"</span>] <span class="sc">&amp;</span> Y<span class="sc">&lt;</span>bboxMS13[<span class="st">"ymax"</span>]) <span class="sc">|&gt;</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">distinct</span>(), </span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>              <span class="fu">aes</span>(X, Y, <span class="at">color =</span> <span class="fu">factor</span>(area)), </span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">shape =</span> <span class="dv">16</span>, </span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_sf</span>(<span class="at">data  =</span> mapMS13mileBuffer, </span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill  =</span> <span class="cn">NA</span>, </span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_sf</span>(<span class="at">data      =</span> mapSZms13,</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill      =</span> <span class="cn">NA</span>, </span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">color     =</span> <span class="st">"red"</span>, </span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>   <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"D"</span>, <span class="at">name =</span> <span class="st">"Area"</span>) <span class="sc">+</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>   <span class="co"># crop to area near MS13 safety zone</span></span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>   <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(bboxMS13<span class="sc">$</span>xmin, bboxMS13<span class="sc">$</span>xmax), </span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">ylim =</span> <span class="fu">c</span>(bboxMS13<span class="sc">$</span>ymin, bboxMS13<span class="sc">$</span>ymax), </span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>   <span class="co"># larger points in the legend</span></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>   <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">4</span>))) <span class="sc">+</span></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ggplotLACrimeData" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ggplotLACrimeData-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-ggplotLACrimeData-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ggplotLACrimeData-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: Plot of Los Angeles crime locations near the MS13 gang injunction safety zones
</figcaption>
</figure>
</div>
</div>
</div>
<p>A very useful operation is to find out which crimes occurred inside, near, or farther outside an area. We will figure out which crimes occurred inside the safety zone, in a one-mile buffer around the safety zone, or more than a mile away from the safety zone. We will filter to just those crimes that occurred in areas near the MS13 safety zone. This step is not essential, but it can save some computer time. There is no need for R to try to figure out if crimes in LAPD Area 4 fell inside the MS13 safety zone. All of those crimes are much more than a mile from the safety zone.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># just get those crimes in areas near the MS13 safety zone</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="ot">&lt;-</span> dataCrime <span class="sc">|&gt;</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(area <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">11</span>,<span class="dv">20</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are going to use two different methods so you learn about different ways of solving these problems. The first method will use the now familiar <code>st_intersects()</code> function. In our <code>dataCrimeMS13</code> data frame we are going to make a new column that labels whether a crime is inside the injunction safety zone (SZ), within a one-mile buffer around the safety zone (buffer), or beyond the buffer (outside).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a variable to label the crime's location</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>iSZ <span class="ot">&lt;-</span> mapSZms13 <span class="sc">|&gt;</span> <span class="fu">st_intersects</span>(dataCrimeMS13) <span class="sc">|&gt;</span> <span class="fu">unlist</span>()</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>iBuff <span class="ot">&lt;-</span> mapSZms13 <span class="sc">|&gt;</span> </span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">5280</span>) <span class="sc">|&gt;</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_difference</span>(mapSZms13) <span class="sc">|&gt;</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersects</span>(dataCrimeMS13) <span class="sc">|&gt;</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unlist</span>()</span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="ot">&lt;-</span> dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">place1 =</span> <span class="fu">case_when</span>(</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">row_number</span>() <span class="sc">%in%</span> iSZ   <span class="sc">~</span> <span class="st">"SZ"</span>,</span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">row_number</span>() <span class="sc">%in%</span> iBuff <span class="sc">~</span> <span class="st">"buffer"</span>,</span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="st">"outside"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now <code>dataCrimeMS13</code> has a new column <code>place1</code> categorizing the location of the incident relative to the MS13 gang injunction safety zone.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dataCrimeMS13, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 27 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 6461916 ymin: 1836559 xmax: 6486290 ymax: 1859520
Projected CRS: NAD83 / California zone 5 (ftUS)
      dr_no               date_rptd                date_occ time_occ area
1  90631215 2010-01-05T00:00:00.000 2010-01-05T00:00:00.000      150    6
2 100100501 2010-01-03T00:00:00.000 2010-01-02T00:00:00.000     2100    1
3 100100506 2010-01-05T00:00:00.000 2010-01-04T00:00:00.000     1650    1
  area_name rpt_dist_no part_1_2 crm_cd
1 Hollywood         646        2    900
2   Central         176        1    122
3   Central         162        1    442
                               crm_cd_desc        mocodes vict_age vict_sex
1                 VIOLATION OF COURT ORDER 1100 0400 1402       47        F
2                          RAPE, ATTEMPTED           0400       47        F
3 SHOPLIFTING - PETTY THEFT ($950 &amp; UNDER)      0344 1402       23        M
  vict_descent premis_cd      premis_desc weapon_used_cd
1            W       101           STREET            102
2            H       103            ALLEY            400
3            B       404 DEPARTMENT STORE             NA
                                     weapon_desc status  status_desc crm_cd_1
1                                       HAND GUN     IC  Invest Cont      900
2 STRONG-ARM (HANDS, FIST, FEET OR BODILY FORCE)     IC  Invest Cont      122
3                                                    AA Adult Arrest      442
  crm_cd_2 crm_cd_3 crm_cd_4                               location
1      998       NA       NA        CAHUENGA                     BL
2       NA       NA       NA        8TH                          ST
3       NA       NA       NA 700 W  7TH                          ST
                     cross_street                geometry  place1
1 HOLLYWOOD                    BL POINT (6461916 1859520)  buffer
2 SAN PEDRO                    ST POINT (6486290 1836559) outside
3                                 POINT (6483602 1839950) outside</code></pre>
</div>
</div>
<p>Let’s check that all the crimes are correctly labeled with a map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_sf</span>(<span class="at">data =</span> mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>              <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">5280</span>),       </span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_sf</span>(<span class="at">data =</span> mapSZms13, </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">color =</span> <span class="st">"red"</span>, </span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">linewidth =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_sf</span>(<span class="at">data =</span> dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>              <span class="co"># filter to points in bounding box</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>              <span class="fu">st_filter</span>(<span class="fu">st_as_sfc</span>(bboxMS13)),</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>           <span class="fu">aes</span>(<span class="at">color =</span> place1),</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">shape =</span> <span class="dv">16</span>, </span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">size =</span> <span class="fl">0.3</span>, </span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>   <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">SZ=</span><span class="st">"red"</span>, <span class="at">buffer=</span><span class="st">"blue"</span>, <span class="at">outside=</span> <span class="st">"green"</span>),</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>                      <span class="at">name   =</span> <span class="st">"Location"</span>) <span class="sc">+</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>   <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(bboxMS13<span class="sc">$</span>xmin, bboxMS13<span class="sc">$</span>xmax), </span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">ylim =</span> <span class="fu">c</span>(bboxMS13<span class="sc">$</span>ymin, bboxMS13<span class="sc">$</span>ymax),</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>   <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">4</span>))) <span class="sc">+</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ggplotLACrimeDataMS13" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ggplotLACrimeDataMS13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-ggplotLACrimeDataMS13-1.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ggplotLACrimeDataMS13-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15: Plot of MS13 safety zone with a one-mile buffer and Los Angeles crime locations
</figcaption>
</figure>
</div>
</div>
</div>
<p>So using <code>st_intersects()</code> can correctly label the locations of different crimes.</p>
<p>Let’s try a second approach using <code>st_join()</code>, a spatial version of the joins that we did when studying SQL. First, we will make a new spatial object with three polygons, the MS13 safety zone, the buffer, and the region outside the buffer. We will label those three polygons and use <code>st_join()</code> to ask each crime in which polygon they fall.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># combine the geometries of the three polygons</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>mapA <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="co"># inside safety zone</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>          mapSZms13 <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>(),</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>          <span class="co"># ring buffer around safety zone</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>          mapSZms13 <span class="sc">|&gt;</span> </span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">5280</span>) <span class="sc">|&gt;</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_difference</span>(mapSZms13) <span class="sc">|&gt;</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_geometry</span>(),</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>          <span class="co"># outside ring buffer</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>          mapSZms13 <span class="sc">|&gt;</span> </span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">80</span><span class="sc">*</span><span class="dv">5280</span>) <span class="sc">|&gt;</span> </span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_difference</span>(mapSZms13 <span class="sc">|&gt;</span> </span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">5280</span>)) <span class="sc">|&gt;</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_geometry</span>())</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="co"># create an sf object</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a>mapA <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(<span class="at">place2=</span><span class="fu">c</span>(<span class="st">"SZ"</span>,<span class="st">"buffer"</span>,<span class="st">"outside"</span>),</span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">geom=</span>mapA)</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mapA, <span class="at">main=</span><span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="11_Working_with_geographic_data_files/figure-html/unnamed-chunk-32-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="ot">&lt;-</span> dataCrimeMS13 <span class="sc">|&gt;</span> <span class="fu">st_join</span>(mapA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>st_join()</code> will add a new column <code>place2</code> to the <code>dataCrimeMS13</code> data frame containing the label of the polygon in which it landed. Indeed, <code>dataCrimeMS13</code> now has a <code>place2</code> column categorizing the incident location.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 28 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 6461916 ymin: 1836559 xmax: 6486290 ymax: 1859520
Projected CRS: NAD83 / California zone 5 (ftUS)
      dr_no               date_rptd                date_occ time_occ area
1  90631215 2010-01-05T00:00:00.000 2010-01-05T00:00:00.000      150    6
2 100100501 2010-01-03T00:00:00.000 2010-01-02T00:00:00.000     2100    1
3 100100506 2010-01-05T00:00:00.000 2010-01-04T00:00:00.000     1650    1
  area_name rpt_dist_no part_1_2 crm_cd
1 Hollywood         646        2    900
2   Central         176        1    122
3   Central         162        1    442
                               crm_cd_desc        mocodes vict_age vict_sex
1                 VIOLATION OF COURT ORDER 1100 0400 1402       47        F
2                          RAPE, ATTEMPTED           0400       47        F
3 SHOPLIFTING - PETTY THEFT ($950 &amp; UNDER)      0344 1402       23        M
  vict_descent premis_cd      premis_desc weapon_used_cd
1            W       101           STREET            102
2            H       103            ALLEY            400
3            B       404 DEPARTMENT STORE             NA
                                     weapon_desc status  status_desc crm_cd_1
1                                       HAND GUN     IC  Invest Cont      900
2 STRONG-ARM (HANDS, FIST, FEET OR BODILY FORCE)     IC  Invest Cont      122
3                                                    AA Adult Arrest      442
  crm_cd_2 crm_cd_3 crm_cd_4                               location
1      998       NA       NA        CAHUENGA                     BL
2       NA       NA       NA        8TH                          ST
3       NA       NA       NA 700 W  7TH                          ST
                     cross_street  place1  place2                geometry
1 HOLLYWOOD                    BL  buffer  buffer POINT (6461916 1859520)
2 SAN PEDRO                    ST outside outside POINT (6486290 1836559)
3                                 outside outside POINT (6483602 1839950)</code></pre>
</div>
</div>
<p>And we can confirm that both methods produce the same results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">count</span>(place1, place2) <span class="sc">|&gt;</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_drop_geometry</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   place1  place2      n
1      SZ      SZ 119113
2  buffer  buffer 312971
3 outside outside 643801</code></pre>
</div>
</div>
<p>Does crime behave differently inside the safety zone compared with the areas beyond the safety zone? Let’s break down the crime counts by year and plot them. We are going to divide the crime count by their average so that they are on the same scale. The area beyond the buffer is very large and it does not make sense to compare their counts directly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="ot">&lt;-</span> dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">date_occ =</span> date_occ <span class="sc">|&gt;</span> <span class="fu">ymd_hms</span>())</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="co"># count the number of crimes by year and area</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">year</span>(date_occ) <span class="sc">&lt;</span> <span class="dv">2025</span>) <span class="sc">|&gt;</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">count</span>(place1, <span class="at">year=</span><span class="fu">year</span>(date_occ)) <span class="sc">|&gt;</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(place1) <span class="sc">|&gt;</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>   <span class="co"># normalize to the average crime count over the period</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">relativeN =</span> n<span class="sc">/</span><span class="fu">mean</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ungroup</span>()</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>a <span class="sc">|&gt;</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span>n) <span class="sc">|&gt;</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>   <span class="fu">pivot_wider</span>(<span class="at">names_from=</span>place1, <span class="at">values_from=</span>relativeN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 4
    year    SZ buffer outside
   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1  2010 0.916  0.926   0.925
 2  2011 0.862  0.905   0.889
 3  2012 0.924  0.906   0.914
 4  2013 0.867  0.861   0.876
 5  2014 0.951  0.902   0.907
 6  2015 0.493  0.703   0.959
 7  2016 1.63   1.36    1.09 
 8  2017 1.11   1.10    1.10 
 9  2018 1.11   1.10    1.14 
10  2019 1.05   1.06    1.12 
11  2020 0.975  0.964   0.960
12  2021 1.10   1.07    1.04 
13  2022 1.22   1.26    1.22 
14  2023 1.22   1.23    1.19 
15  2024 0.576  0.650   0.686</code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(a, <span class="fu">aes</span>(<span class="at">x=</span>year, <span class="at">y=</span>relativeN, <span class="at">color=</span>place1)) <span class="sc">+</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="at">SZ=</span><span class="st">"red"</span>, <span class="at">buffer=</span><span class="st">"blue"</span>, <span class="at">outside=</span><span class="st">"green"</span>)) <span class="sc">+</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Number of crimes relative to the average"</span>, <span class="at">color =</span> <span class="st">"Location"</span>) <span class="sc">+</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ggplotRelativeTrends" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ggplotRelativeTrends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-ggplotRelativeTrends-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ggplotRelativeTrends-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16: Trends in crime relative to their average
</figcaption>
</figure>
</div>
</div>
</div>
<p>For the most part the crime trends look the same. However, in which years do we see some large differences? The large dip and spike are in 2015 and 2016. Remember when loading the crime data we noticed that 2015 and 2016 data looked miscoded in areas 19, 20, and 21.</p>
<section id="exercises-1" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="exercises-1"><span class="header-section-number">5.1</span> Exercises</h2>
<ol start="10" type="1">
<li><p>How many 2019 crimes occurred inside safety zones?</p></li>
<li><p>How many crimes per square mile inside safety zones? (Hint 1: use <code>st_area()</code> for area)</p></li>
<li><p>How many crimes per square mile outside the safety zone, but within 1 mile of a safety zone</p></li>
</ol>
</section>
</section>
<section id="creating-new-geographic-objects" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Creating new geographic objects</h1>
<p>Remember that the MS13 safety zone had a northern and southern component. We are going to work with just the southern component, but first we need to separate it from its northern component. We will work through a several ways to accomplish this. The first will work directly with the <code>sf</code> objects and the second is an interactive method.</p>
<p>Right now, the MS13 map is stored as <code>MULTIPOLYGON</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is</span>(<span class="fu">st_geometry</span>(mapSZms13))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sfc_MULTIPOLYGON" "sfc"              "oldClass"        </code></pre>
</div>
</div>
<p>A <code>MULTIPOLYGON</code> object is useful for managing a spatial object that involves several non-overlapping polygons, like this MS13 injunction, or the Hawaiian Islands, or the city of San Diego. We now want to break it apart into separate <code>POLYGON</code> objects using <code>st_cast()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(mapSZms13, <span class="st">"POLYGON"</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 2 features and 5 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 6463941 ymin: 1841325 xmax: 6479076 ymax: 1858250
Projected CRS: NAD83 / California zone 5 (ftUS)
                      NAME  case_no                   Safety_Zn
1   Rampart/East Hollywood BC311766 Rampart/East Hollywood (MS)
1.1 Rampart/East Hollywood BC311766 Rampart/East Hollywood (MS)
           gang_name  startDate                       geometry
1   Mara Salvatrucha 2004-04-08 POLYGON ((6476845 1841356, ...
1.1 Mara Salvatrucha 2004-04-08 POLYGON ((6473357 1850297, ...</code></pre>
</div>
</div>
<p>Now we can see that <code>a</code> has two distinct polygons. The second row corresponds to the southern polygon. Let’s store that one separately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># which one is further south?</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="ot">&lt;-</span> a <span class="sc">|&gt;</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">minLat =</span> </span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>             <span class="co"># coordinates applies to entire column</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_coordinates</span>(geometry) <span class="sc">|&gt;</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>             <span class="co"># split by polygon</span></span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>             <span class="fu">group_by</span>(L2) <span class="sc">|&gt;</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>             <span class="fu">summarize</span>(<span class="at">minLat=</span><span class="fu">min</span>(Y)) <span class="sc">|&gt;</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">pull</span>(minLat)) <span class="sc">|&gt;</span></span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_min</span>(minLat)</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13s" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13s-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13s-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13s-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;17: Southern polygon from the MS13 safety zone
</figcaption>
</figure>
</div>
</div>
</div>
<p>Using <code>st_cast()</code> is the most direct method. However, sometimes the shapes are more complicated and we might want to select the shape interactively. To interactively select the southern component, use the R function <code>locator()</code>. It allows you to click on an R plot and will return the coordinates of the points you have selected. Let’s first get the plot of the full MS13 safety zone in the plot window.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13all" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13all-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13all-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13all-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18: Both polygons marking the MS13 safety zone
</figcaption>
</figure>
</div>
</div>
</div>
<p>Next, run <code>boxXY &lt;- locator()</code>. In the top left of the plot window you will see “Locator active (Esc to finish)”. Then click several points around the southern MS13 polygon as if you are cutting out just the southern polygon. When you have finished clicking the points, press the Esc key on your keyboard. Here are the places that I clicked.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-MS13locatorBox" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13locatorBox-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13locatorBox-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13locatorBox-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19: Points selected with <code>locator()</code> to extract southern polygon
</figcaption>
</figure>
</div>
</div>
</div>
<p>My <code>boxXY</code> looks like this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>boxXY</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$x
[1] 6465406 6472950 6482201 6479978 6466041

$y
[1] 1847679 1849148 1846845 1839619 1839818</code></pre>
</div>
</div>
<p>Yours will almost certainly look different and may even have more elements. Check to make sure your box completely surrounds the southern safety zone.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make the end of the box reconnect back to the beginning</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>boxXY<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="fu">c</span>(boxXY<span class="sc">$</span>x, boxXY<span class="sc">$</span>x[<span class="dv">1</span>])</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>boxXY<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">c</span>(boxXY<span class="sc">$</span>y, boxXY<span class="sc">$</span>y[<span class="dv">1</span>])</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">st_geometry</span>(mapSZms13), </span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">range</span>(<span class="fu">st_coordinates</span>(<span class="fu">st_geometry</span>(mapSZms13))[,<span class="st">"Y"</span>],</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>                boxXY<span class="sc">$</span>y))</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(boxXY, <span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13locatorBox2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13locatorBox2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13locatorBox2-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13locatorBox2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20: Polygon formed from <code>locator()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>If you are not satisfied with your outline, just rerun <code>boxXY &lt;- locator()</code> and rerun this plot to check your revised box.</p>
<p>We need to turn this collection of points defining our box into an <code>sf</code> object. We will explore the several ways you can accomplish this. The first version we will use WKT (well known text), a way of using plain text to describe a geometric shape. This is a particularly useful method if you are able to type out the specific shape that you want or need to copy a shape from another application that also uses the WKT format. You have probably already noticed a <code>geometry</code> variable in the <code>dataCrime</code> data frame that has elements that look like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>dataCrime <span class="sc">|&gt;</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_as_text</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "POINT (6479964 1816123)"</code></pre>
</div>
</div>
<p>You can also make polygons using a <code>POLYGON</code> tag instead of a <code>POINT</code> tag. Here is what the first safety zone looks like in WKT format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry</span>(mapSZ) <span class="sc">|&gt;</span> <span class="fu">pluck</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>POLYGON ((6435396 1924413, 6435607 1924174, 6435792 1923960, 6435872 1923867, 6436158 1923545, 6436349 1923325, 6437295 1922239, 6438231 1921163, 6438243 1921150, 6437992 1920931, 6437743 1920714, 6437495 1920498, 6437246 1920282, 6436874 1919958, 6436472 1919608, 6435940 1919144, 6435771 1918998, 6435633 1918878, 6435311 1918597, 6435143 1918451, 6435086 1918401, 6434689 1918857, 6434139 1919485, 6433857 1919808, 6433742 1919938, 6433189 1920572, 6433040 1920743, 6432908 1920894, 6432706 1921120, 6432500 1921348, 6432467 1921385, 6432279 1921596, 6432227 1921658, 6432296 1921718, 6432466 1921866, 6433399 1922679, 6433404 1922683, 6433857 1923073, 6434399 1923545, 6434790 1923885, 6434822 1923914, 6435396 1924413))</code></pre>
</div>
</div>
<p>We can paste together the coordinates in <code>boxXY</code> to match this format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>boxTemp <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"POLYGON(("</span>,</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">paste</span>(<span class="fu">paste</span>(boxXY<span class="sc">$</span>x, boxXY<span class="sc">$</span>y), <span class="at">collapse=</span><span class="st">","</span>),</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"))"</span>)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>boxTemp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "POLYGON((6465406 1847679,6472950 1849148,6482201 1846845,6479978 1839619,6466041 1839818,6465406 1847679))"</code></pre>
</div>
</div>
<p>The text looks correct, so now we convert it to a simple features object, making sure to also tell R the coordinate system that we are using.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>boxTemp <span class="ot">&lt;-</span> <span class="fu">st_as_sfc</span>(boxTemp,</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">crs=</span><span class="fu">st_crs</span>(mapSZms13))</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">1839619</span>,<span class="dv">1858250</span>))</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>boxTemp <span class="sc">|&gt;</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13sWKT" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13sWKT-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13sWKT-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13sWKT-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21: Polygon from <code>locator()</code> constructed from WKT
</figcaption>
</figure>
</div>
</div>
</div>
<p>That was the WKT method. Let’s try the <code>st_polygon()</code> method. <code>st_polygon()</code> takes in a matrix of coordinates and creates a simple features spatial object. Actually, it takes in a list of matrices. That way you can make objects like the northern and southern MS13 safety zones where the coordinates of each of the separate components are collected in one list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>boxTemp <span class="ot">&lt;-</span> <span class="fu">cbind</span>(boxXY<span class="sc">$</span>x, boxXY<span class="sc">$</span>y) <span class="sc">|&gt;</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">list</span>() <span class="sc">|&gt;</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_polygon</span>() <span class="sc">|&gt;</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_sfc</span>(<span class="at">crs=</span><span class="fu">st_crs</span>(mapSZms13))</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">1839619</span>,<span class="dv">1858250</span>))</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>boxTemp <span class="sc">|&gt;</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13sstpolygon" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13sstpolygon-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13sstpolygon-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13sstpolygon-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22: Polygon from <code>locator()</code> constructed using <code>st_polygon()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now the only reason we did this process of creating <code>boxTemp</code> is so that we could select just the southern polygon, which is the intersection of our <code>boxTemp</code> and the original <code>mapSZms13</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="ot">&lt;-</span> mapSZms13 <span class="sc">|&gt;</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(boxTemp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13sFinal" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13sFinal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13sFinal-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13sFinal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;23: Final selection of southern MS13 safety zone
</figcaption>
</figure>
</div>
</div>
</div>
<p>With the southern MS13 safety zone extracted, let’s explore the streets in this neighborhood.</p>
</section>
<section id="overlaying-a-street-map" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Overlaying a street map</h1>
<p>Let’s load the street map for Los Angeles County, the county that contains the city of Los Angeles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using tigris</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>mapLAstreet <span class="ot">&lt;-</span> <span class="fu">roads</span>(<span class="at">state=</span><span class="st">"CA"</span>,</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">county=</span><span class="st">"Los Angeles"</span>,</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">year=</span><span class="dv">2019</span>,</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">class=</span><span class="st">"sf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you would rather work from a shapefile stored locally on your computer, the file to use is <code>tl_2019_06037_roads.shp</code>. The naming convention says that this is a TIGER line file, from 2019, for state 06 (California), for county 037 (Los Angeles County), containing roads. Los Angeles County is large and this file has over 135,000 street segments. It can take a little while to load and project.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>mapLAstreet <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"11_shapefiles_and_data/tl_2019_06037_roads.shp"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Regardless of the method, we then need to make sure we use the same projection for the streets as the injunction map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>mapLAstreet <span class="ot">&lt;-</span> mapLAstreet <span class="sc">|&gt;</span> </span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_transform</span>(<span class="fu">st_crs</span>(mapSZms13s))</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>mapLAstreet <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 4 fields
Geometry type: LINESTRING
Dimension:     XY
Bounding box:  xmin: 6487582 ymin: 1835878 xmax: 6510389 ymax: 1857279
Projected CRS: NAD83 / California zone 5 (ftUS)
       LINEARID             FULLNAME RTTYP MTFCC                       geometry
1 1101576755652 Golden State Fwy Rmp     M S1400 LINESTRING (6487884 1856781...
2 1101576692583       Pomona Fwy Rmp     M S1400 LINESTRING (6510389 1835878...
3 1101576663753          Soto St Rmp     M S1400 LINESTRING (6501699 1845173...</code></pre>
</div>
</div>
<p>The file contains the geometry of each road (<code>geometry</code>), the name of the road (<code>FULLNAME</code>), and the type of road (<code>RTTYP</code> and <code>MTFCC</code>). <code>RTTYP</code> stands for “<a href="https://www.census.gov/library/reference/code-lists/route-type-codes.html">route type code</a>” where</p>
<ul>
<li>M: Common (municipal) street</li>
<li>C: County road</li>
<li>S: State road (e.g.&nbsp;Highway 1, Route 66)</li>
<li>I: Interstate highway (e.g.&nbsp;I-5, I-405, I-10)</li>
<li>U: U.S. highway (U.S. 101)</li>
<li>O: Other (e.g.&nbsp;forest roads, utility service roads)</li>
</ul>
<p><code>MTFCC</code> stands for “<a href="https://www.census.gov/library/reference/code-lists/mt-feature-class-codes.html">MAF/TIGER Feature Class Code</a>”. There are numerous MTFCC one for just about every geographical feature you can think of (e.g shorelines, water towers, campgrounds), but some of the common ones for our purposes here are</p>
<ul>
<li>s1100: Primary road (limited access highway)</li>
<li>s1200: Secondary road (main arteries and smaller highways)</li>
<li>s1400: Local neighborhood road</li>
<li>s1730: Alley</li>
<li>s1780: Parking lot</li>
</ul>
<p>We do not need all the streets of Los Angeles County, so let’s just get the ones that intersect without southern MS13 safety zone. <code>st_filter()</code> by default uses <code>st_intersect()</code> to decide whether to keep a street or not. You can alter this default behavior by choosing a differ value for <code>.predicate</code> like <code>st_crosses()</code> or <code>st_within()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="ot">&lt;-</span> mapLAstreet <span class="sc">|&gt;</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_filter</span>(mapSZms13s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a look at the streets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span> </span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13streets" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13streets-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13streets-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13streets-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;24: Streets that intersect the southern MS13 safety zone
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>   <span class="co"># crop to mapSZms13s bounding box</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_crop</span>(mapSZms13s) <span class="sc">|&gt;</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="ot">&lt;-</span> mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_crop</span>(mapSZms13s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13streetsCrop" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13streetsCrop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13streetsCrop-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13streetsCrop-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;25: Streets that intersect the southern MS13 safety zone, cropped to safety zone bounding box
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now we have our safety zone and the streets that run through the safety zone. Let’s put some street names over the map so we can read it more like a street map. It is hard to do this perfectly, but the following steps will work for our purposes. For each street segment we want to select a point on the street, near or inside the safety zone where we will put the label. We will use <code>st_line_sample()</code> with <code>sample=0.5</code> to select a point in the middle of the line (<code>mid_X</code>, <code>mid_Y</code>). Some streets run north/south, others east/west, and others diagonally. So, we need to figure out an angle for the label too. I will also find another point (<code>p_lo_X</code>, <code>p_lo_Y</code>) a little before the point where we will place the label. The slope of the line connecting the two points <code>p_lo</code> and <code>mid</code> can give us the angle of the street at that point (has it been a while since you have used the <a href="https://www.khanacademy.org/math/precalculus/x9e81a4f98389efdf:trig/x9e81a4f98389efdf:inverse-trig/v/inverse-trig-functions-arctan">inverse tangent function</a>?)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save geometry column</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(FULLNAME)) <span class="sc">|&gt;</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>()   </span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> <span class="fl">0.001</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="ot">&lt;-</span> mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(FULLNAME)) <span class="sc">|&gt;</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">mid =</span> geometry <span class="sc">|&gt;</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_cast</span>(<span class="st">"LINESTRING"</span>) <span class="sc">|&gt;</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_line_sample</span>(<span class="at">sample =</span> <span class="fl">0.5</span>) <span class="sc">|&gt;</span> </span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_cast</span>(<span class="st">"POINT"</span>) <span class="sc">|&gt;</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>             <span class="fu">data.frame</span>(),</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">p_lo =</span>  geometry <span class="sc">|&gt;</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_cast</span>(<span class="st">"LINESTRING"</span>) <span class="sc">|&gt;</span></span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_line_sample</span>(<span class="at">sample =</span> <span class="fl">0.5</span><span class="sc">-</span>delta) <span class="sc">|&gt;</span> </span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_cast</span>(<span class="st">"POINT"</span>) <span class="sc">|&gt;</span></span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>             <span class="fu">st_coordinates</span>() <span class="sc">|&gt;</span></span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>             <span class="fu">data.frame</span>()) <span class="sc">|&gt;</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unnest_wider</span>(mid,  <span class="at">names_sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span> <span class="co"># separate into X &amp; Y columns</span></span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">unnest_wider</span>(p_lo, <span class="at">names_sep=</span><span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a>   <span class="co"># convert the slope of the street to the angle</span></span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">ang =</span> <span class="fu">atan2</span>(mid_Y <span class="sc">-</span> p_lo_Y, mid_X <span class="sc">-</span> p_lo_X) <span class="sc">*</span> <span class="dv">180</span> <span class="sc">/</span> pi,</span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>          <span class="co"># want -90 to 90 only, flip any upside down angles</span></span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">ang =</span> <span class="fu">if_else</span>(<span class="fu">abs</span>(ang) <span class="sc">&gt;</span> <span class="dv">90</span>,</span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>                        ang <span class="sc">-</span> <span class="fu">sign</span>(ang)<span class="sc">*</span><span class="dv">180</span>,</span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>                        ang)) <span class="sc">|&gt;</span></span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(mapMS13street)) <span class="sc">|&gt;</span></span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">geometry =</span> g) </span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb138-34"><a href="#cb138-34" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb138-35"><a href="#cb138-35" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span></span>
<span id="cb138-36"><a href="#cb138-36" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb138-37"><a href="#cb138-37" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb138-38"><a href="#cb138-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mapMS13street))</span>
<span id="cb138-39"><a href="#cb138-39" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb138-40"><a href="#cb138-40" aria-hidden="true" tabindex="-1"></a>   <span class="fu">text</span>(mapMS13street<span class="sc">$</span>mid_X[i], </span>
<span id="cb138-41"><a href="#cb138-41" aria-hidden="true" tabindex="-1"></a>        mapMS13street<span class="sc">$</span>mid_Y[i], </span>
<span id="cb138-42"><a href="#cb138-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> mapMS13street<span class="sc">$</span>FULLNAME[i], </span>
<span id="cb138-43"><a href="#cb138-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">srt =</span> mapMS13street<span class="sc">$</span>ang[i], </span>
<span id="cb138-44"><a href="#cb138-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb138-45"><a href="#cb138-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13sStreetFinal" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13sStreetFinal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13sStreetFinal-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13sStreetFinal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;26: Street map through the southern MS13 safety zone
</figcaption>
</figure>
</div>
</div>
</div>
<p>Wilshire Blvd is a major street that runs from the Pacific Ocean to downtown Los Angeles running through the MS13 safety zone along the way. You can see it highlighted in green here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">border =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mapMS13street))</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">text</span>(mapMS13street<span class="sc">$</span>mid_X[i], mapMS13street<span class="sc">$</span>mid_Y[i], </span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> mapMS13street<span class="sc">$</span>FULLNAME[i], </span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">srt =</span> mapMS13street<span class="sc">$</span>ang[i], <span class="at">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>mapWilshire <span class="ot">&lt;-</span> mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(FULLNAME<span class="sc">==</span><span class="st">"Wilshire Blvd"</span>)</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>mapWilshire <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"green"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13Wilshire" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13Wilshire-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13Wilshire-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13Wilshire-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;27: Street map in southern MS13 safety zone, Wilshire Blvd highlighted in green
</figcaption>
</figure>
</div>
</div>
</div>
<p>We are going to count how many crimes occurred within 100 feet of Wilshire Blvd. Note that it is unlikely that any crimes will have occurred exactly on top of the line that is representing Wilshire Blvd in the map. We will work through two different methods. The first method will use a 100-foot buffer and count the crimes that land in it. The second method will compute the distance each crime is to Wilshire Blvd.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a 100-foot buffer, but only the part that is in the ms13 safety zone</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>mapWilbuffer <span class="ot">&lt;-</span> mapWilshire <span class="sc">|&gt;</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(mapSZms13s)</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="ot">&lt;-</span> dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">inWilbuf =</span> <span class="fu">lengths</span>(<span class="fu">st_intersects</span>(geometry, mapWilbuffer)) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">border =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mapMS13street))</span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">text</span>(mapMS13street<span class="sc">$</span>mid_X[i], mapMS13street<span class="sc">$</span>mid_Y[i], </span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> mapMS13street<span class="sc">$</span>FULLNAME[i], </span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">srt =</span> mapMS13street<span class="sc">$</span>ang[i], <span class="at">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>mapWilbuffer <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"green"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a><span class="co"># add crime locations</span></span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inWilbuf) <span class="sc">|&gt;</span></span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb140-23"><a href="#cb140-23" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"blue"</span>, <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13WilshireCrime" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13WilshireCrime-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13WilshireCrime-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13WilshireCrime-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;28: Crime locations on Wilshire Blvd
</figcaption>
</figure>
</div>
</div>
</div>
<p>And what are the most common crime types along Wilshire Blvd?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inWilbuf) <span class="sc">|&gt;</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">count</span>(crm_cd_desc) <span class="sc">|&gt;</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_max</span>(n, <span class="at">n=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                     crm_cd_desc    n
1                       BATTERY - SIMPLE ASSAULT 1136
2             THEFT PLAIN - PETTY ($950 &amp; UNDER) 1020
3                          BURGLARY FROM VEHICLE  677
4                                        ROBBERY  571
5 ASSAULT WITH DEADLY WEAPON, AGGRAVATED ASSAULT  537</code></pre>
</div>
</div>
<p>In the previous method we created a 100-foot buffer and then asked which crimes landed inside the buffer. Alternatively, we can compute the distance between each crime point location and Wilshire Blvd. This second method takes a lot more computational effort and will be much slower, but you should be familiar with the functions that compute distances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># explore st_distance() with first 10 incidents</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="sc">|&gt;</span> </span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_distance</span>(mapWilshire)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Units: [US_survey_foot]
           [,1]
 [1,] 15785.502
 [2,]  9710.824
 [3,]  5491.395
 [4,]  6892.608
 [5,] 10238.992
 [6,]  4944.466
 [7,]  7296.952
 [8,] 10995.036
 [9,] 12953.951
[10,]  6707.485</code></pre>
</div>
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>mapWilbuffer <span class="sc">|&gt;</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">border=</span><span class="st">"green"</span>)</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a>   <span class="co"># include only those within 100 feet of Wilshire Blvd</span></span>
<span id="cb145-12"><a href="#cb145-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">as.numeric</span>(<span class="fu">st_distance</span>(geometry, mapWilshire)) <span class="sc">&lt;</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb145-13"><a href="#cb145-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb145-14"><a href="#cb145-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"purple"</span>, <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13WilshireCrimeDist" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13WilshireCrimeDist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13WilshireCrimeDist-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13WilshireCrimeDist-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;29: Crime locations on Wilshire Blvd, computed using <code>st_distance()</code>
</figcaption>
</figure>
</div>
</div>
</div>
<section id="exercise-2" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="exercise-2"><span class="header-section-number">7.1</span> Exercise</h2>
<ol start="13" type="1">
<li>Are there more crimes along Wilshire Blvd or S Vermont Ave?</li>
</ol>
</section>
</section>
<section id="find-which-line-is-closest-to-a-point" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Find which line is closest to a point</h1>
<p>We are going to find out which street is closest to each point. Yes, the crimes already have an address associated with them, but we will use that to check our work.</p>
<p>First, let’s subset our crime data so we just have crimes that fall into the MS13 southern safety zone.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13s <span class="ot">&lt;-</span> dataCrimeMS13 <span class="sc">|&gt;</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_filter</span>(mapSZms13s)</span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13s <span class="sc">|&gt;</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">"blue"</span>,<span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13CrimeLocations" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13CrimeLocations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13CrimeLocations-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13CrimeLocations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;30: Crime locations in southern MS13 safety zone
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now let’s compute the distance for each point to the closest street in <code>mapMS13street</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(dataCrimeMS13s, mapMS13street)</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(d) <span class="co"># row for each crime, column for each street</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 68558   107</code></pre>
</div>
</div>
<p><code>d</code> is a matrix of distances with 68,558 rows and 107 columns, a distance from every crime point to every street. Now let’s figure out which street is closest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for each row (crime) find out which column (street)</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>iClose <span class="ot">&lt;-</span> <span class="fu">apply</span>(d, <span class="dv">1</span>, which.min)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="co"># for the first crime check that the original address is similar to closest street</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13s <span class="sc">|&gt;</span> </span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(location, cross_street)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  location cross_street
1      7TH     WILSHIRE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice</span>(iClose[<span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(FULLNAME)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  FULLNAME
  &lt;chr&gt;   
1 W 7th St</code></pre>
</div>
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">border =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mapMS13street))</span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">text</span>(mapMS13street<span class="sc">$</span>mid_X[i], mapMS13street<span class="sc">$</span>mid_Y[i], </span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> mapMS13street<span class="sc">$</span>FULLNAME[i], </span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">srt =</span> mapMS13street<span class="sc">$</span>ang[i], <span class="at">cex =</span> <span class="fl">0.6</span>)</span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13s <span class="sc">|&gt;</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">head</span>(<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-MS13ExampleClosest" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-MS13ExampleClosest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-MS13ExampleClosest-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-MS13ExampleClosest-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;31: Example crime location checking its nearest street
</figcaption>
</figure>
</div>
</div>
</div>
<p>Which streets have the most incidents?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using distance calculation</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(mapMS13street<span class="sc">$</span>FULLNAME[iClose]) <span class="sc">|&gt;</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sort</span>() <span class="sc">|&gt;</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tail</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
       S Berendo St       S Catalina St         S Hoover St W James M Wood Blvd 
               2118                2201                2280                2353 
           W 8th St            W 4th St            W 5th St            W 7th St 
               2868                3100                3275                4636 
      Wilshire Blvd            W 6th St 
               6318                9923 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or, just using the addresses</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>dataCrimeMS13s<span class="sc">$</span>location <span class="sc">|&gt;</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">gsub</span>(<span class="st">"^[0-9]+ "</span>, <span class="st">""</span>, ) <span class="sc">|&gt;</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">gsub</span>(<span class="st">" * "</span>, <span class="st">" "</span>, <span class="at">x=</span>_) <span class="sc">|&gt;</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">table</span>() <span class="sc">|&gt;</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sort</span>() <span class="sc">|&gt;</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">tail</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in gsub(dataCrimeMS13s$location, "^[0-9]+ ", "", ): argument 'pattern'
has length &gt; 1 and only the first element will be used</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  
1 </code></pre>
</div>
</div>
<section id="exercise-3" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="exercise-3"><span class="header-section-number">8.1</span> Exercise</h2>
<ol start="14" type="1">
<li>There are LA Metrorail stations along Wilshire at S Western Ave (farthest west), S Normandie Ave, S Vermont Ave, and S Alvarado St (farthest east). How many crimes occurred within 500 feet of a Metrorail station?</li>
</ol>
<p>Hint: Consider finding the stations using <code>st_intersection()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>mapMetro <span class="ot">&lt;-</span> mapLAstreet <span class="sc">|&gt;</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(FULLNAME <span class="sc">%in%</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">c</span>(<span class="st">"S Western Ave"</span>,<span class="st">"S Normandie Ave"</span>,</span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">"S Vermont Ave"</span>,<span class="st">"S Alvarado St"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(mapLAstreet <span class="sc">|&gt;</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">filter</span>(FULLNAME<span class="sc">==</span><span class="st">"Wilshire Blvd"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="15" type="1">
<li>RFK Community Schools occupy the site between S Mariposa Ave and S Catalina St and W 8th St and Wilshire Blvd. How many crimes occurred within 500 feet of the RFK School? The RFK Schools occupies the site of the Ambassador Hotel where Robert F. Kennedy was assassinated on June 5, 1968. Trump Wilshire Associates bought it in 1989, followed by a decade long fight with the Los Angeles School District who wished to take the site by eminent domain. The schools opened in 2011.)</li>
</ol>
<p>Hints:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> mapLAstreet <span class="sc">|&gt;</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(FULLNAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S Mariposa Ave"</span>,<span class="st">"S Catalina St"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(mapLAstreet <span class="sc">|&gt;</span> </span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">filter</span>(FULLNAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"W 8th St"</span>,<span class="st">"Wilshire Blvd"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> <span class="fu">plot</span>(<span class="at">border =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">3</span>, <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the intersection points (why are there five?)</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>a <span class="sc">|&gt;</span> </span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"orange"</span>, <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="dv">1</span>)</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="co"># keep only the four most eastern points</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   dropping the west Mariposa/Wilshire intersection</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> a <span class="sc">|&gt;</span></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_max</span>(<span class="fu">st_coordinates</span>(geometry)[,<span class="st">"X"</span>],</span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">n=</span><span class="dv">4</span>)</span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a>a <span class="sc">|&gt;</span> <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">pch=</span><span class="dv">21</span>, <span class="at">bg =</span><span class="st">"orange"</span>, <span class="at">col=</span><span class="st">"red"</span>, <span class="at">cex=</span><span class="fl">1.5</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a><span class="co"># compute the convex hull of the remaining four points</span></span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a>mapRFKschool <span class="ot">&lt;-</span> a <span class="sc">|&gt;</span></span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_union</span>() <span class="sc">|&gt;</span></span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_convex_hull</span>()</span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a>mapRFKschool <span class="sc">|&gt;</span></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"purple"</span>, <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">lwd=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-RFKschool" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-RFKschool-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="11_Working_with_geographic_data_files/figure-html/fig-RFKschool-1.svg" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-RFKschool-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;32: Boundaries of the RFK school
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="make-a-kml-file-to-post-to-google-maps" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Make a KML file to post to Google Maps</h1>
<p>KML (keyhole markup language) is a standard way that Google Maps stores geographic information (Keyhole was a company that Google acquired, renaming their product Google Earth). You can convert any of the maps you make in R to KML format and post them to Google Maps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span> </span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_write</span>(<span class="at">dsn=</span><span class="st">"ms13.kml"</span>, </span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">layer=</span> <span class="st">"ms13"</span>, </span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">driver=</span><span class="st">"KML"</span>,</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Deleting source `ms13.kml' using driver `KML'
Writing layer `ms13' to data source `ms13.kml' using driver `KML'
Writing 1 features with 5 fields and geometry type Multi Polygon.</code></pre>
</div>
</div>
<p>Now you can navigate to <a href="http://www.google.com/mymaps">http://www.google.com/mymaps</a>, click import, select your <code>ms13.kml</code> file, and then it will be visible as an overlay on top of the usual Google map of Los Angeles.</p>
</section>
<section id="solutions-to-the-exercises" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Solutions to the exercises</h1>
<ol type="1">
<li>Find the largest and smallest safety zones (use <code>st_area(mapSZ)</code>)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">area =</span> <span class="fu">st_area</span>(geometry)) <span class="sc">|&gt;</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarize</span>(<span class="at">iMin =</span> <span class="fu">which.min</span>(area),</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">iMax =</span> <span class="fu">which.max</span>(area))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  iMin iMax
1   17   51</code></pre>
</div>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or a more complete solution that combines areas by case number</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(case_no) <span class="sc">|&gt;</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">area =</span> <span class="fu">st_area</span>(<span class="fu">st_union</span>(geometry))) <span class="sc">|&gt;</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(area) <span class="sc">|&gt;</span></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>,<span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 2 features and 2 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 6451005 ymin: 1807966 xmax: 6489595 ymax: 1834100
Projected CRS: NAD83 / California zone 5 (ftUS)
# A tibble: 2 × 3
  case_no                area                                           geometry
  &lt;chr&gt;    [US_survey_foot^2]                         &lt;POLYGON [US_survey_foot]&gt;
1 VC024170           4116319. ((6453176 1831871, 6452515 1831860, 6451005 18320…
2 BC397522         445331479. ((6461015 1823912, 6476533 1823933, 6479929 18239…</code></pre>
</div>
</div>
<ol start="2" type="1">
<li>Plot all the safety zones. Color the largest in one color and the smallest in another color</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">area =</span> <span class="fu">st_area</span>(geometry)) <span class="sc">|&gt;</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_min</span>(area) <span class="sc">|&gt;</span></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">"salmon"</span>)</span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">area =</span> <span class="fu">st_area</span>(geometry)) <span class="sc">|&gt;</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_max</span>(area) <span class="sc">|&gt;</span></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">col=</span><span class="st">"turquoise"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="11_Working_with_geographic_data_files/figure-html/unnamed-chunk-51-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>The smallest one is very tiny, just to the northeast of the biggest one.</p>
<ol start="3" type="1">
<li>Use <code>st_overlaps(mapSZ, mapSZ, sparse=FALSE)</code> or <code>print(st_overlaps(mapSZ, mapSZ, sparse=TRUE), n=Inf, max_nb=Inf)</code> to find two safety zones that overlap (not just touch at the edges)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_overlaps</span>(mapSZ, <span class="at">sparse =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span>(<span class="at">n=</span><span class="cn">Inf</span>, <span class="at">max_nb=</span><span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sparse geometry binary predicate list of length 65, where the predicate
was `overlaps'
 1: (empty)
 2: 57
 3: (empty)
 4: 57
 5: 57
 6: 7, 8
 7: 6, 13, 49
 8: 6
 9: 10, 12
 10: 9, 11, 12, 65
 11: 10, 65
 12: 9, 10
 13: 7
 14: 15, 16, 20, 22, 52, 59, 60, 61, 62
 15: 14, 61
 16: 14, 20, 22, 52, 60, 61, 62
 17: (empty)
 18: (empty)
 19: 63
 20: 14, 16, 22, 60
 21: (empty)
 22: 14, 16, 20, 60
 23: (empty)
 24: (empty)
 25: (empty)
 26: (empty)
 27: (empty)
 28: 60
 29: (empty)
 30: 33, 37, 38, 51, 53
 31: 63
 32: (empty)
 33: 30, 37, 51
 34: 46
 35: 36
 36: 35, 39
 37: 30, 33
 38: 30, 46, 51, 53
 39: 36
 40: 46, 51
 41: (empty)
 42: (empty)
 43: 54, 64
 44: (empty)
 45: (empty)
 46: 34, 38, 40, 51
 47: 56
 48: (empty)
 49: 7
 50: (empty)
 51: 30, 33, 38, 40, 46, 53
 52: 14, 16, 59, 62
 53: 30, 38, 51
 54: 43, 64
 55: (empty)
 56: 47
 57: 2, 4, 5
 58: (empty)
 59: 14, 52, 62
 60: 14, 16, 20, 22, 28
 61: 14, 15, 16
 62: 14, 16, 52, 59
 63: 19, 31
 64: 43, 54
 65: 10, 11</code></pre>
</div>
</div>
<ol start="4" type="1">
<li>With the two safety zones that you found in the previous question, plot using three different colors the first safety zone, second safety zone, and their intersection (hint: use <code>st_intersection()</code>)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice</span>(<span class="fu">c</span>(<span class="dv">30</span>,<span class="dv">51</span>)) <span class="sc">|&gt;</span></span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice</span>(<span class="dv">30</span>) <span class="sc">|&gt;</span></span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_difference</span>(mapSZ <span class="sc">|&gt;</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">slice</span>(<span class="dv">51</span>)) <span class="sc">|&gt;</span></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"red"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb172-12"><a href="#cb172-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice</span>(<span class="dv">51</span>) <span class="sc">|&gt;</span></span>
<span id="cb172-13"><a href="#cb172-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_difference</span>(mapSZ <span class="sc">|&gt;</span></span>
<span id="cb172-14"><a href="#cb172-14" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">slice</span>(<span class="dv">30</span>)) <span class="sc">|&gt;</span></span>
<span id="cb172-15"><a href="#cb172-15" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb172-16"><a href="#cb172-16" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"blue"</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb172-17"><a href="#cb172-17" aria-hidden="true" tabindex="-1"></a>mapSZ <span class="sc">|&gt;</span></span>
<span id="cb172-18"><a href="#cb172-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice</span>(<span class="dv">51</span>) <span class="sc">|&gt;</span></span>
<span id="cb172-19"><a href="#cb172-19" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(mapSZ <span class="sc">|&gt;</span></span>
<span id="cb172-20"><a href="#cb172-20" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">slice</span>(<span class="dv">30</span>)) <span class="sc">|&gt;</span></span>
<span id="cb172-21"><a href="#cb172-21" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb172-22"><a href="#cb172-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"purple"</span>,</span>
<span id="cb172-23"><a href="#cb172-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="11_Working_with_geographic_data_files/figure-html/unnamed-chunk-53-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<ol start="5" type="1">
<li>Census tracts that just touch the boundary of the safety zone are included. To eliminate, rather than use <code>st_intersects()</code> with <code>mapSZms13</code>, use <code>st_intersects()</code> with <code>st_buffer()</code> with a negative <code>dist</code> to select census tracts</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>mapCens <span class="sc">|&gt;</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_filter</span>(mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>                <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="sc">-</span><span class="dv">200</span>)) <span class="sc">|&gt;</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist =</span> <span class="sc">-</span><span class="dv">200</span>) <span class="sc">|&gt;</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>,</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">lwd=</span><span class="dv">3</span>,</span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="11_Working_with_geographic_data_files/figure-html/unnamed-chunk-54-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or </span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="sc">-</span><span class="dv">200</span>) <span class="sc">|&gt;</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_intersects</span>(mapCens) <span class="sc">|&gt;</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlist</span>()</span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>mapCens <span class="ot">&lt;-</span> mapCens <span class="sc">|&gt;</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">inMS13 =</span> (<span class="fu">row_number</span>() <span class="sc">%in%</span> i))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>mapCens <span class="sc">|&gt;</span> </span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_filter</span>(mapSZms13 <span class="sc">|&gt;</span> <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="sc">-</span><span class="dv">50</span>)) <span class="sc">|&gt;</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>mapSZms13 <span class="sc">|&gt;</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="11_Working_with_geographic_data_files/figure-html/unnamed-chunk-55-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<ol start="6" type="1">
<li>Create a map of all census tracts in the City of Los Angeles within 1 mile of one of the safety zones (you choose which safety zone)</li>
<li>Color each area based on a census feature (e.g.&nbsp;% non-white, or some other feature from the ACS data)</li>
<li>Add the polygon with your injunction zone</li>
<li>Add other injunction zones that intersect with your map</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get total population for each census tract</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>dataRes <span class="ot">&lt;-</span> <span class="fu">get_acs</span>(<span class="at">geography =</span> <span class="st">"tract"</span>,</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">variables =</span> <span class="st">"B01001_001E"</span>,</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">state     =</span> <span class="st">"CA"</span>,</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">county    =</span> <span class="st">"Los Angeles"</span>,</span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">year      =</span> <span class="dv">2019</span>,</span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">survey    =</span> <span class="st">"acs5"</span>,</span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">cache_table =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(GEOID, estimate) <span class="sc">|&gt;</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">rename</span>(<span class="at">pop =</span> estimate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Getting data from the 2015-2019 5-year ACS</code></pre>
</div>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="co"># merge total population into census map</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>mapCens <span class="ot">&lt;-</span> mapCens <span class="sc">|&gt;</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(dataRes, <span class="fu">join_by</span>(GEOID))</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a><span class="co"># census tracts within 1 mile of safety zone #51</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>mapCensMS13 <span class="ot">&lt;-</span> mapCens <span class="sc">|&gt;</span></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_filter</span>(mapSZ <span class="sc">|&gt;</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">slice</span>(<span class="dv">51</span>) <span class="sc">|&gt;</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>                <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">5280</span>))</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> mapCensMS13, </span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"grey60"</span>, </span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">linewidth =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> mapCensMS13,</span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">label =</span> pop),</span>
<span id="cb178-18"><a href="#cb178-18" aria-hidden="true" tabindex="-1"></a>               <span class="co"># function for selecting label points</span></span>
<span id="cb178-19"><a href="#cb178-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">fun.geometry =</span> st_point_on_surface,</span>
<span id="cb178-20"><a href="#cb178-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="fl">2.5</span>, </span>
<span id="cb178-21"><a href="#cb178-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"black"</span>, </span>
<span id="cb178-22"><a href="#cb178-22" aria-hidden="true" tabindex="-1"></a>               <span class="at">check_overlap =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb178-23"><a href="#cb178-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> mapSZ <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">51</span>), </span>
<span id="cb178-24"><a href="#cb178-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, </span>
<span id="cb178-25"><a href="#cb178-25" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"red"</span>, </span>
<span id="cb178-26"><a href="#cb178-26" aria-hidden="true" tabindex="-1"></a>          <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb178-27"><a href="#cb178-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb178-28"><a href="#cb178-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="11_Working_with_geographic_data_files/figure-html/unnamed-chunk-56-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<ol start="10" type="1">
<li>How many 2019 crimes occurred inside safety zones?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>nSZcrimes <span class="ot">&lt;-</span> dataCrime <span class="sc">|&gt;</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">year</span>(date_occ)<span class="sc">==</span><span class="dv">2019</span>) <span class="sc">|&gt;</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_filter</span>(mapSZ <span class="sc">|&gt;</span> </span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">st_union</span>()) <span class="sc">|&gt;</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nrow</span>()</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>nSZcrimes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 100879</code></pre>
</div>
</div>
<ol start="11" type="1">
<li>How many crimes per square mile inside safety zones? (Hint 1: use <code>st_area()</code> for area)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(units)</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="co"># use set_units() to convert to square miles</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   equivalent to multiplying by 5820^2</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set_units</span>(nSZcrimes <span class="sc">/</span> <span class="fu">st_area</span>(<span class="fu">st_union</span>(mapSZ)), <span class="at">value=</span><span class="st">"1/mile^2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>913.4101 [1/mile^2]</code></pre>
</div>
</div>
<ol start="12" type="1">
<li>How many crimes per square mile outside the safety zone, but within 1 mile of a safety zone</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>mapBuf <span class="ot">&lt;-</span> mapSZ <span class="sc">|&gt;</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_union</span>() <span class="sc">|&gt;</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">5280</span>) <span class="sc">|&gt;</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_difference</span>(<span class="fu">st_union</span>(mapSZ)) <span class="sc">|&gt;</span></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(mapLA)</span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>nBufCrimes <span class="ot">&lt;-</span> dataCrime <span class="sc">|&gt;</span></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">year</span>(date_occ)<span class="sc">==</span><span class="dv">2019</span>) <span class="sc">|&gt;</span></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_filter</span>(mapBuf) <span class="sc">|&gt;</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">nrow</span>()</span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a>nBufCrimes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 63952</code></pre>
</div>
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set_units</span>(nBufCrimes <span class="sc">/</span> <span class="fu">st_area</span>(mapBuf), <span class="at">value=</span><span class="st">"1/mile^2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>476.5197 [1/mile^2]</code></pre>
</div>
</div>
<ol start="13" type="1">
<li>Are there more crimes along Wilshire Blvd or S Vermont Ave?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(FULLNAME<span class="sc">==</span><span class="st">"S Vermont Ave"</span>) <span class="sc">|&gt;</span></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(mapSZms13s) <span class="sc">|&gt;</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersects</span>(dataCrime) <span class="sc">|&gt;</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">lengths</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4405</code></pre>
</div>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(FULLNAME<span class="sc">==</span><span class="st">"Wilshire Blvd"</span>) <span class="sc">|&gt;</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(mapSZms13s) <span class="sc">|&gt;</span></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersects</span>(dataCrime) <span class="sc">|&gt;</span></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">lengths</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 8953</code></pre>
</div>
</div>
<ol start="14" type="1">
<li>There are LA Metrorail stations along Wilshire at S Western Ave (farthest west), S Normandie Ave, S Vermont Ave, and S Alvarado St (farthest east). How many crimes occurred within 500 feet of a Metrorail station?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>mapMetro <span class="ot">&lt;-</span> mapLAstreet <span class="sc">|&gt;</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(FULLNAME <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S Western Ave"</span>,<span class="st">"S Normandie Ave"</span>,</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"S Vermont Ave"</span>,<span class="st">"S Alvarado St"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersection</span>(mapLAstreet <span class="sc">|&gt;</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">filter</span>(FULLNAME<span class="sc">==</span><span class="st">"Wilshire Blvd"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: attribute variables are assumed to be spatially constant throughout
all geometries</code></pre>
</div>
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>mapMS13street <span class="sc">|&gt;</span> </span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span> </span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>()</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>mapSZms13s <span class="sc">|&gt;</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">border=</span><span class="st">"red"</span>, <span class="at">lwd=</span><span class="dv">3</span>, <span class="at">add=</span><span class="cn">TRUE</span>)</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>mapMetro <span class="sc">|&gt;</span></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">col=</span><span class="st">"purple"</span>, <span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="dv">2</span>)</span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>mapMetro <span class="sc">|&gt;</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot</span>(<span class="at">add=</span><span class="cn">TRUE</span>, <span class="at">border=</span><span class="st">"purple"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="11_Working_with_geographic_data_files/figure-html/unnamed-chunk-61-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how many crimes near each station?</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>mapMetro <span class="sc">|&gt;</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersects</span>(dataCrime) <span class="sc">|&gt;</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">lengths</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1367  900 1303 1531</code></pre>
</div>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># how many crimes overall?</span></span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>mapMetro <span class="sc">|&gt;</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_union</span>() <span class="sc">|&gt;</span>  <span class="co"># combine them into one shape</span></span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersects</span>(dataCrime) <span class="sc">|&gt;</span></span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">lengths</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5101</code></pre>
</div>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>mapMetro <span class="sc">|&gt;</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersects</span>(dataCrime) <span class="sc">|&gt;</span></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">lengths</span>() <span class="sc">|&gt;</span></span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5101</code></pre>
</div>
</div>
<ol start="15" type="1">
<li>RFK Community Schools occupy the site between S Mariposa Ave and S Catalina St and W 8th St and Wilshire Blvd. How many crimes occurred within 500 feet of the RFK School?</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>mapRFKschool <span class="sc">|&gt;</span></span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_buffer</span>(<span class="at">dist=</span><span class="dv">500</span>) <span class="sc">|&gt;</span></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">st_intersects</span>(dataCrime) <span class="sc">|&gt;</span></span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">lengths</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6488</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>