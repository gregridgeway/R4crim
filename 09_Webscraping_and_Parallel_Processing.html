<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Greg Ridgeway">
<meta name="author" content="Ruth Moyer">
<meta name="dcterms.date" content="2025-08-24">

<title>Webscraping and Parallel Processing</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="09_Webscraping_and_Parallel_Processing_files/libs/clipboard/clipboard.min.js"></script>
<script src="09_Webscraping_and_Parallel_Processing_files/libs/quarto-html/quarto.js"></script>
<script src="09_Webscraping_and_Parallel_Processing_files/libs/quarto-html/popper.min.js"></script>
<script src="09_Webscraping_and_Parallel_Processing_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="09_Webscraping_and_Parallel_Processing_files/libs/quarto-html/anchor.min.js"></script>
<link href="09_Webscraping_and_Parallel_Processing_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="09_Webscraping_and_Parallel_Processing_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="09_Webscraping_and_Parallel_Processing_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="09_Webscraping_and_Parallel_Processing_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="09_Webscraping_and_Parallel_Processing_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="09_Webscraping_and_Parallel_Processing_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="09_Webscraping_and_Parallel_Processing_files/libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#scraping-one-page" id="toc-scraping-one-page" class="nav-link" data-scroll-target="#scraping-one-page"><span class="header-section-number">2</span> Scraping one page</a></li>
  <li><a href="#scraping-multiple-pages" id="toc-scraping-multiple-pages" class="nav-link" data-scroll-target="#scraping-multiple-pages"><span class="header-section-number">3</span> Scraping Multiple Pages</a></li>
  <li><a href="#parallel-computing" id="toc-parallel-computing" class="nav-link" data-scroll-target="#parallel-computing"><span class="header-section-number">4</span> Parallel Computing</a></li>
  <li><a href="#fun-with-movie-data" id="toc-fun-with-movie-data" class="nav-link" data-scroll-target="#fun-with-movie-data"><span class="header-section-number">5</span> Fun With Movie Data</a>
  <ul class="collapse">
  <li><a href="#inflation-adjust" id="toc-inflation-adjust" class="nav-link" data-scroll-target="#inflation-adjust"><span class="header-section-number">5.1</span> Inflation adjust</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="09_Webscraping_and_Parallel_Processing.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Webscraping and Parallel Processing</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Authors</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Greg Ridgeway <a href="mailto:gridge@upenn.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Pennsylvania
          </p>
      </div>
    <div class="quarto-title-meta-contents">
    <p class="author">Ruth Moyer <a href="mailto:moyruth@upenn.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Pennsylvania
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 24, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<!-- In terminal -->
<!-- quarto render 09_Webscraping_and_Parallel_Processing.qmd -->
<!-- git commit 09-* -m "commit message" -->
<!-- git status -->
<!-- git push -->
<!-- A function for automating the numbering and wording of the exercise questions -->
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>At the end of our discussion about regular expressions, we introduced the concept of web scraping. Not all online data is in a tidy, downloadable format such as a .csv or .RData file. Yet, patterns in the underlying HTML code and regular expressions together provide a valuable way to “scrape” data off of a webpage. Here, we’re going to work through an example of webscraping. We’re going to get data on ticket sales of every movie, for every day going back to 2010.</p>
<p>As a preliminary matter, some R packages, such as <code>rvest</code> and <code>chromote</code>, can help with web scraping. Eventually you may wish to explore those packages. For now, we are going to work with basic fundamentals so that you have the most flexibility to extract data from most websites.</p>
<p>First, you will need to make sure that you can access the underlying HTML code for the webpage that you want to scrape. In most browsers you can simply right click on a webpage and then click “View Page Source.” If you’re using Microsoft Edge, you can right click on the webpage, click “View Source” and then look at the “Debugger” tab. In Safari select “Settings,” select the “Advanced” tab, check “Show Develop menu,” and then whenever viewing a page you can right click and select “show page source”.</p>
<p>Have a look at the webpage <a href="http://www.the-numbers.com/box-office-chart/daily/2025/07/04">http://www.the-numbers.com/box-office-chart/daily/2025/07/04</a>. This page contains information about the movies that were shown in theaters on July 4, 2025 and the amount of money (in dollars) that each of those movies grossed that day.</p>
<p>Have a look at the HTML code by looking at the page source for this page using the methods described above. The first 10 lines should look something like this:</p>
<pre><code> &lt;!DOCTYPE html&gt;
 &lt;html xmlns:og="https://ogp.me/ns#"&gt;
 &lt;head&gt;
 &lt;link rel="icon" href="https://www.the-numbers.com/images/logo_2021/favicon.ico"&gt;
 &lt;script async src="https://www.googletagmanager.com/gtag/js?id=G-5K2DT3XQN5"&gt;&lt;/script&gt;
 &lt;script&gt;window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-5K2DT3XQN5');&lt;/script&gt;
 &lt;meta http-equiv="PICS-Label" content='(PICS-1.1 "https://www.icra.org/ratingsv02.html" l gen true for "https://www.the-numbers.com/" r (cb 1 lz 1 nz 1 oz 1 vz 1) "https://www.rsac.org/ratingsv01.html" l gen true for "https://www.the-numbers.com/" r (n 0 s 0 v 0 l 0))'&gt;
 &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
 &lt;meta name="format-detection" content="telephone=no"&gt;   &lt;!-- for apple mobile --&gt;
 &lt;script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"&gt;&lt;/script&gt;</code></pre>
<p>This is all HTML code to set up the page. If you scroll down a few hundred lines, you will find code that looks like this:</p>
<pre><code> &lt;thead&gt;&lt;tr&gt;&lt;th&gt;&amp;nbsp;&lt;/th&gt;&lt;th&gt;&amp;nbsp;&lt;/th&gt;&lt;th&gt;Movie Title&lt;/th&gt;&lt;th&gt;Distributor&lt;/th&gt;&lt;th&gt;Gross&lt;/th&gt;&lt;th&gt;%YD&lt;/th&gt;&lt;th&gt;%LW&lt;/th&gt;&lt;th&gt;Theaters&lt;/th&gt;&lt;th&gt;Per&lt;BR&gt;Theater&lt;/th&gt;&lt;th&gt;Total&lt;BR&gt;Gross&lt;/th&gt;&lt;th&gt;Days In&lt;br&gt;Release&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;
 &lt;tr&gt;
 &lt;td data-sort="1" class="data"&gt;1&lt;/td&gt;
 &lt;td data-sort="1" class="data"&gt;(1)&lt;/td&gt;
 &lt;td&gt;&lt;b&gt;&lt;a href="/movie/Jurassic-World-Rebirth-(2025)#tab=box-office"&gt;Jurassic World Rebirth&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;
 &lt;td&gt;&lt;a href="/market/distributor/Universal"&gt;Universal&lt;/a&gt;&lt;/td&gt;
 &lt;td class="data"&gt;$26,235,450&lt;/td&gt;
 &lt;td data-sort="4" class="data chart_up"&gt;+4%&lt;/td&gt;
 &lt;td data-sort="0" class="data"&gt;&amp;nbsp;&lt;/td&gt;
 &lt;td data-sort="4308" class="data"&gt;4,308&lt;/td&gt;
 &lt;td data-sort="6090" class="data chart_grey"&gt;$6,090&lt;/td&gt;
 &lt;td data-sort="82040080"class="data"&gt;$82,040,080&lt;/td&gt;
 &lt;td class="data"&gt;3&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td data-sort="2" class="data"&gt;2&lt;/td&gt;
 &lt;td data-sort="2" class="data"&gt;(2)&lt;/td&gt;
 &lt;td&gt;&lt;b&gt;&lt;a href="/movie/F1-The-Movie-(2025)#tab=box-office"&gt;F1: The Movie&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;
 &lt;td&gt;&lt;a href="/market/distributor/Warner-Bros"&gt;Warner Bros.&lt;/a&gt;&lt;/td&gt;
 &lt;td class="data"&gt;$6,960,390&lt;/td&gt;
 &lt;td data-sort="14" class="data chart_up"&gt;+14%&lt;/td&gt;</code></pre>
<p>I see Jurassic World Rebirth and F1: The Movie. In addition to the movie name, there are ticket sales, number of theaters, and more. It is all wrapped in a lot of HTML code to make it look pretty on a web page, but for our purposes we just want to pull those numbers out.</p>
<p><code>scan()</code> is a basic R function for reading in text, from the keyboard, from files, from the web, … however data might arrive. Giving <code>scan()</code> a URL causes <code>scan()</code> to pull down the HTML code for that page and return it to you. Let’s try one page of movie data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">scan</span>(<span class="st">"http://www.the-numbers.com/box-office-chart/daily/2025/07/04"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">what=</span><span class="st">""</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># examine the first few lines</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>a[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "&lt;!DOCTYPE html&gt;"                                                                         
[2] "&lt;html xmlns:og=\"https://ogp.me/ns#\"&gt;"                                                  
[3] "&lt;head&gt;"                                                                                  
[4] "&lt;link rel=\"icon\" href=\"https://www.the-numbers.com/images/logo_2021/favicon.ico\"&gt;"   
[5] "&lt;script async src=\"https://www.googletagmanager.com/gtag/js?id=G-5K2DT3XQN5\"&gt;&lt;/script&gt;"</code></pre>
</div>
</div>
<p><code>what=""</code> tells <code>scan()</code> to expect plain text and <code>sep="\n"</code> tells <code>scan()</code> to separate each element when it reaches a line feed character, signaling the end of a line.</p>
<p>Some websites are more complex or use different text encoding. On those websites <code>scan()</code> produces unintelligible text. The <code>GET()</code> function from the <code>httr</code> package can sometimes resolve this.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>resp <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"http://www.the-numbers.com/box-office-chart/daily/2025/07/04"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>a1 <span class="ot">&lt;-</span> <span class="fu">content</span>(resp, <span class="at">as=</span><span class="st">"text"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>a1 <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(a1,<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)[[<span class="dv">1</span>]]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(a1[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="at">sep=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html xmlns:og="https://ogp.me/ns#"&gt;
&lt;head&gt;
&lt;link rel="icon" href="https://www.the-numbers.com/images/logo_2021/favicon.ico"&gt;
&lt;script async src="https://www.googletagmanager.com/gtag/js?id=G-5K2DT3XQN5"&gt;&lt;/script&gt;
&lt;script&gt;window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-5K2DT3XQN5');&lt;/script&gt;
&lt;meta http-equiv="PICS-Label" content='(PICS-1.1 "https://www.icra.org/ratingsv02.html" l gen true for "https://www.the-numbers.com/" r (cb 1 lz 1 nz 1 oz 1 vz 1) "https://www.rsac.org/ratingsv01.html" l gen true for "https://www.the-numbers.com/" r (n 0 s 0 v 0 l 0))'&gt;
&lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
&lt;meta name="format-detection" content="telephone=no"&gt;   &lt;!-- for apple mobile --&gt;
&lt;script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"&gt;&lt;/script&gt;</code></pre>
</div>
</div>
<p>Also, some Mac users will encounter snags with both of these methods and receive “403 Forbidden” errors while their Mac colleague right next to them on the same network will not. I have not figured out why this happens, but have found that making R masquerade as different browser sometimes works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>resp <span class="ot">&lt;-</span> <span class="fu">GET</span>(<span class="st">"http://www.the-numbers.com/box-office-chart/daily/2025/07/04"</span>, </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">user_agent</span>(<span class="st">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/537.13+ (KHTML, like Gecko) Version/5.1.7 Safari/534.57.2"</span>))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>a1 <span class="ot">&lt;-</span> <span class="fu">content</span>(resp, <span class="at">as=</span><span class="st">"text"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>a1 <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(a1,<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="scraping-one-page" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Scraping one page</h1>
<p>Now that we have stored in the variable <code>a</code> the HTML code for one day’s movie data in R, let’s apply some regular expressions to extract the data. The HTML code includes a lot of lines that do not involve data that interests us. There is code for making the page look nice and code for presenting advertisements. Let’s start by finding the lines that have the movie names in them.</p>
<p>Going back to the HTML code, I noticed that both the line with <em>Jurassic World Rebirth</em> and <em>F1: The Movie</em> have the sequence of characters “#tab=box-office”. By finding a pattern of characters that always precedes the text that interests us, we can use it to grep the lines we want. Let’s find every line that has “#tab=box-office” in it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"#tab=box-office"</span>, a)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 317 330 343 356 369 382 395 408 421 434 447 460 473 486 499 512 525 538 551
[20] 564 577 590 603 616 629 642 655 668 681 694</code></pre>
</div>
</div>
<p>These are the line numbers that, if the pattern holds, contain our movie titles. Note that the source code that you might see in your browser may be a little different from the line numbers you see here. Even if you run this code on a different day, you might get different line numbers because some of the code, code for advertisements in particular, can frequently change.</p>
<p>Let’s see what these lines of HTML code look like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>a[i]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Jurassic-World-Rebirth-(2025)#tab=box-office\"&gt;Jurassic World Rebirth&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                    
 [2] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/F1-The-Movie-(2025)#tab=box-office\"&gt;F1: The Movie&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                       
 [3] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/How-to-Train-Your-Dragon-(2025)#tab=box-office\"&gt;How to Train Your Dragon&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                
 [4] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Elio-(2025)#tab=box-office\"&gt;Elio&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                                        
 [5] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/28-Years-Later-(2025)#tab=box-office\"&gt;28 Years Later&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                    
 [6] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/M3GAN-2-0-(2025)#tab=box-office\"&gt;M3GAN 2.0&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                              
 [7] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Lilo-and-Stitch-(2025)#tab=box-office\"&gt;Lilo &amp; Stitch&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                    
 [8] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Mission-Impossible-The-Final-Reckoning-(2025)#tab=box-office\"&gt;Mission: Impossible—The F&amp;hellip;&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"         
 [9] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/This-is-Spinal-Tap#tab=box-office\"&gt;This is Spinal Tap&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                   
[10] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Materialists-(2025)#tab=box-office\"&gt;Materialists&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                        
[11] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Sardaar-Ji-3-(2025-India)#tab=box-office\"&gt;Sardaar Ji 3&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                  
[12] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/From-the-World-of-John-Wick-Ballerina-(2025)#tab=box-office\"&gt;From the World of John Wi&amp;hellip;&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"          
[13] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Phoenician-Scheme-The-(2025)#tab=box-office\"&gt;The Phoenician Scheme&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                      
[14] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Karate-Kid-Legends-(2025)#tab=box-office\"&gt;Karate Kid: Legends&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                           
[15] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Final-Destination-Bloodlines-(2025)#tab=box-office\"&gt;Final Destination: Bloodl&amp;hellip;&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                   
[16] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Life-of-Chuck-The-(2025)#tab=box-office\"&gt;The Life of Chuck&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                              
[17] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Sinners-(2025)#tab=box-office\"&gt;Sinners&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                                  
[18] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Sorry-Baby-(2025)#tab=box-office\"&gt;Sorry, Baby&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                           
[19] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Thunderbolts-(2025)#tab=box-office\"&gt;Thunderbolts*&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                       
[20] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Last-Rodeo-The-(2025)#tab=box-office\"&gt;The Last Rodeo&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                    
[21] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Friendship-(2025)#tab=box-office\"&gt;Friendship&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                            
[22] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Bring-Her-Back-(2025)#tab=box-office\"&gt;Bring Her Back&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                    
[23] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Jane-Austen-a-gache-ma-vie-(2025-France)#tab=box-office\"&gt;Jane Austen Wrecked My Life&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                    
[24] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Hearts-of-Darkness-A-Filmmakers-Apocalypse#tab=box-office\"&gt;Hearts of Darkness: A Fil&amp;hellip;&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"            
[25] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Hot-Milk-(2025-United-Kingdom)#tab=box-office\"&gt;Hot Milk&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                 
[26] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Unholy-Trinity-The-(2025)#tab=box-office\"&gt;The Unholy Trinity&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                            
[27] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Ran-(1985-Japan)#tab=box-office\"&gt;Ran&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                                                    
[28] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Dragon-Heart-Adventures-Beyond-This-World-(2025-Japan)#tab=box-office\"&gt;Dragon Heart — Adventures&amp;hellip;&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"
[29] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Dangerous-Animals-(2025-Australia)#tab=box-office\"&gt;Dangerous Animals&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                    
[30] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/King-of-Kings-The-(2025-South-Korea)#tab=box-office\"&gt;The King of Kings&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"                                  </code></pre>
</div>
</div>
<p>Double checking and indeed the first line here is <em>Jurassic World Rebirth</em> and the last line is <em>The King of Kings</em>. This matches what is on the web page. We now are quite close to having a list of movies that played in theaters on July 4, 2025. However, as you can see, we have a lot of excess symbols and HTML code to eliminate before we can have a neat list of movie names.</p>
<p>HTML tags are always have the form <code>&lt;some code here&gt;</code>. Therefore, any text between a less than and greater than symbol we should remove. Here is a regular expression that will look for a <code>&lt;</code> followed by a bunch of characters that are not <code>&gt;</code> followed by the HTML tag ending <code>&gt;</code>… and <code>gsub()</code> will delete them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;"</span>, <span class="st">""</span>, a[i])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Jurassic World Rebirth"            "F1: The Movie"                    
 [3] "How to Train Your Dragon"          "Elio"                             
 [5] "28 Years Later"                    "M3GAN 2.0"                        
 [7] "Lilo &amp; Stitch"                     "Mission: Impossible—The F&amp;hellip;"
 [9] "This is Spinal Tap"                "Materialists"                     
[11] "Sardaar Ji 3"                      "From the World of John Wi&amp;hellip;"
[13] "The Phoenician Scheme"             "Karate Kid: Legends"              
[15] "Final Destination: Bloodl&amp;hellip;" "The Life of Chuck"                
[17] "Sinners"                           "Sorry, Baby"                      
[19] "Thunderbolts*"                     "The Last Rodeo"                   
[21] "Friendship"                        "Bring Her Back"                   
[23] "Jane Austen Wrecked My Life"       "Hearts of Darkness: A Fil&amp;hellip;"
[25] "Hot Milk"                          "The Unholy Trinity"               
[27] "Ran"                               "Dragon Heart — Adventures&amp;hellip;"
[29] "Dangerous Animals"                 "The King of Kings"                </code></pre>
</div>
</div>
<p>Perfect! Now we just have movie names. You will see some movie names have strange symbols, like <code>&amp;hellip;</code>. That is the HTML code for horizontal ellipses or “…”. These make the text look prettier on a webpage, but you might need to do more work with <code>gsub()</code> if it is important that these movie names look right.</p>
<p>Let’s put these movie names in a data frame, <code>data0</code>. This data frame currently has only one column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">movie=</span><span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;"</span>, <span class="st">""</span>, a[i]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we also want to get the daily gross for each movie. Let’s take another look at the HTML code for <em>Jurassic World Rebirth</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>a[i[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">8</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "&lt;td&gt;&lt;b&gt;&lt;a href=\"/movie/Jurassic-World-Rebirth-(2025)#tab=box-office\"&gt;Jurassic World Rebirth&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;"
[2] "&lt;td&gt;&lt;a href=\"/market/distributor/Universal\"&gt;Universal&lt;/a&gt;&lt;/td&gt;"                                          
[3] "&lt;td class=\"data\"&gt;$26,235,450&lt;/td&gt;"                                                                       
[4] "&lt;td data-sort=\"4\" class=\"data chart_up\"&gt;+4%&lt;/td&gt;"                                                      
[5] "&lt;td data-sort=\"0\" class=\"data\"&gt;&amp;nbsp;&lt;/td&gt;"                                                            
[6] "&lt;td data-sort=\"4308\" class=\"data\"&gt;4,308&lt;/td&gt;"                                                          
[7] "&lt;td data-sort=\"6090\" class=\"data chart_grey\"&gt;$6,090&lt;/td&gt;"                                              
[8] "&lt;td data-sort=\"82040080\"class=\"data\"&gt;$82,040,080&lt;/td&gt;"                                                 
[9] "&lt;td class=\"data\"&gt;3&lt;/td&gt;"                                                                                 </code></pre>
</div>
</div>
<p>Note that the movie gross is two lines after the movie name. It turns out that this is consistent for all movies. Since <code>i</code> has the line numbers for the movie names, then <code>i+2</code> must be the line numbers containing the daily gross.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>a[i<span class="sc">+</span><span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "&lt;td class=\"data\"&gt;$26,235,450&lt;/td&gt;"      
 [2] "&lt;td class=\"data\"&gt;$6,960,390&lt;/td&gt;"       
 [3] "&lt;td class=\"data\"&gt;$2,909,540&lt;/td&gt;"       
 [4] "&lt;td class=\"data\"&gt;$1,500,046&lt;/td&gt;"       
 [5] "&lt;td class=\"data\"&gt;$1,106,889&lt;/td&gt;"       
 [6] "&lt;td class=\"data\"&gt;$972,945&lt;/td&gt;"         
 [7] "&lt;td class=\"data\"&gt;$962,789&lt;/td&gt;"         
 [8] "&lt;td class=\"data\"&gt;$851,931&lt;/td&gt;"         
 [9] "&lt;td class=\"data\"&gt;$431,360&lt;/td&gt;"         
[10] "&lt;td class=\"data\"&gt;$354,396&lt;/td&gt;"         
[11] "&lt;td class=\"data estimate\"&gt;$220,000&lt;/td&gt;"
[12] "&lt;td class=\"data\"&gt;$201,834&lt;/td&gt;"         
[13] "&lt;td class=\"data\"&gt;$116,865&lt;/td&gt;"         
[14] "&lt;td class=\"data\"&gt;$100,872&lt;/td&gt;"         
[15] "&lt;td class=\"data\"&gt;$85,239&lt;/td&gt;"          
[16] "&lt;td class=\"data\"&gt;$73,304&lt;/td&gt;"          
[17] "&lt;td class=\"data\"&gt;$41,283&lt;/td&gt;"          
[18] "&lt;td class=\"data\"&gt;$32,621&lt;/td&gt;"          
[19] "&lt;td class=\"data\"&gt;$14,381&lt;/td&gt;"          
[20] "&lt;td class=\"data\"&gt;$12,136&lt;/td&gt;"          
[21] "&lt;td class=\"data\"&gt;$4,165&lt;/td&gt;"           
[22] "&lt;td class=\"data\"&gt;$4,158&lt;/td&gt;"           
[23] "&lt;td class=\"data\"&gt;$2,798&lt;/td&gt;"           
[24] "&lt;td class=\"data\"&gt;$2,274&lt;/td&gt;"           
[25] "&lt;td class=\"data\"&gt;$796&lt;/td&gt;"             
[26] "&lt;td class=\"data\"&gt;$680&lt;/td&gt;"             
[27] "&lt;td class=\"data\"&gt;$629&lt;/td&gt;"             
[28] "&lt;td class=\"data\"&gt;$606&lt;/td&gt;"             
[29] "&lt;td class=\"data\"&gt;$506&lt;/td&gt;"             
[30] "&lt;td class=\"data\"&gt;$143&lt;/td&gt;"             </code></pre>
</div>
</div>
<p>Again we need to strip out the HTML tags. We will also remove the dollar signs and commas so that R will recognize it as a number. We will add this to <code>data0</code> also.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>data0<span class="sc">$</span>gross <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;|[$,]"</span>, <span class="st">""</span>, a[i<span class="sc">+</span><span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Take a look at the webpage and compare it to the dataset you have now created. All the values should now match.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     movie    gross
1   Jurassic World Rebirth 26235450
2            F1: The Movie  6960390
3 How to Train Your Dragon  2909540
4                     Elio  1500046
5           28 Years Later  1106889
6                M3GAN 2.0   972945</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(data0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               movie gross
25                          Hot Milk   796
26                The Unholy Trinity   680
27                               Ran   629
28 Dragon Heart — Adventures&amp;hellip;   606
29                 Dangerous Animals   506
30                 The King of Kings   143</code></pre>
</div>
</div>
</section>
<section id="scraping-multiple-pages" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Scraping Multiple Pages</h1>
<p>We have now successfully scraped data for one day. This is usually the hardest part. But if we have R code that can correctly scrape one day’s worth of data <em>and</em> the website is consistent across days, then it is simple to adapt our code to work for <em>all</em> days. So let’s get all movie data from January 1, 2010 through July 31, 2025. That means we are going to be web scraping 5,691 pages of data.</p>
<p>First note that the URL for July 4, 2025 was</p>
<p><code>https://www.the-numbers.com/box-office-chart/daily/2025/07/04</code></p>
<p>We can extract data from any other date by using the same URL, but changing the ending to match the date that we want. Importantly, note that the 07 and the 04 in the URL must have the leading 0 for the URL to return the correct page.</p>
<p>To start, let’s make a list of all the dates that we intend to scrape.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a sequence of all days to scrape</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>dates2scrape <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">ymd</span>(<span class="st">"2010-01-01"</span>), <span class="fu">ymd</span>(<span class="st">"2025-07-31"</span>), <span class="at">by=</span><span class="st">"days"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now <code>dates2scrape</code> contains a collection of all the dates with movie data that we wish to scrape.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>dates2scrape[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2010-01-01" "2010-01-02" "2010-01-03" "2010-01-04" "2010-01-05"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># gsub() can change the - to / to match the appearance of the numbers.com URL</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gsub</span>(<span class="st">"-"</span>, <span class="st">"/"</span>, dates2scrape[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2010/01/01" "2010/01/02" "2010/01/03" "2010/01/04" "2010/01/05"</code></pre>
</div>
</div>
<p>Our plan is to construct a for loop within which we will construct a URL from <code>dates2scrape</code>, pull down the HTML code from that URL, scrape the movie data into a data frame, and then combine the each day’s data frame into one data frame will all of the movie data. First we create a list that will contain each day’s data frame.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(dates2scrape))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On iteration <code>i</code> of our for loop we will store that day’s movie data frame in <code>results[[i]]</code>. The following for loop can take several minutes to run and its speed will depend on your network connection and how responsive the web site is. Before running the entire for loop, it may be a good idea to temporarily set the dates to a short period of time (e.g., a month or two) just to verify that your code is functioning properly. Once you have concluded that the code is doing what you want it to do, you can set the dates so that the for loop runs for the entire analysis period.</p>
<p>This takes about an hour to pull all the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>timeStart <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>() <span class="co"># record the starting time</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(iDate <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(dates2scrape))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>   <span class="co"># useful to know how much is done/left to go</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">message</span>(dates2scrape[iDate])</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>   <span class="co"># construct URL</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>   urlText <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.the-numbers.com/box-office-chart/daily/"</span>,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">gsub</span>(<span class="st">"-"</span>, <span class="st">"/"</span>, dates2scrape[iDate]))</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>   <span class="co"># read in the HTML code... now using UTF8</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>   a <span class="ot">&lt;-</span> <span class="fu">scan</span>(urlText, <span class="at">what=</span><span class="st">""</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">fileEncoding=</span><span class="st">"UTF-8"</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>   <span class="co"># find movies</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>   i <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"#tab=box-office"</span>, a)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>   <span class="co"># get movie names and gross</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>   data0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">movie=</span><span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;"</span>, <span class="st">""</span>, a[i]),</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">gross=</span><span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;|[$,]"</span>,<span class="st">""</span>,a[i<span class="sc">+</span><span class="dv">2</span>])))</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>   <span class="co"># add date into the dataset</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>   data0<span class="sc">$</span>date  <span class="ot">&lt;-</span> dates2scrape[iDate]</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>   results[[iDate]] <span class="ot">&lt;-</span> data0</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate how long it took</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>timeEnd <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>timeEnd<span class="sc">-</span>timeStart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s look at the first 3 lines of the first and last 3 days.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first 6 rows of first 3 days</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">lapply</span>(head)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
                              movie    gross       date
1                            Avatar 25274008 2010-01-01
2                   Sherlock Holmes 14889882 2010-01-01
3 Alvin and the Chipmunks: &amp;hellip; 12998264 2010-01-01
4                  It’s Complicated  7127425 2010-01-01
5                    The Blind Side  4554779 2010-01-01
6                     Up in the Air  4112263 2010-01-01

[[2]]
                              movie    gross       date
1                            Avatar 25835551 2010-01-02
2                   Sherlock Holmes 14373564 2010-01-02
3 Alvin and the Chipmunks: &amp;hellip; 14373273 2010-01-02
4                  It’s Complicated  7691535 2010-01-02
5                    The Blind Side  4997659 2010-01-02
6                     Up in the Air  4457565 2010-01-02

[[3]]
                              movie    gross       date
1                            Avatar 17381129 2010-01-03
2 Alvin and the Chipmunks: &amp;hellip;  7818116 2010-01-03
3                   Sherlock Holmes  7349035 2010-01-03
4                  It’s Complicated  3984005 2010-01-03
5                    The Blind Side  2360311 2010-01-03
6         The Princess and the Frog  2264727 2010-01-03</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first 6 rows of last 3 days</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> <span class="fu">tail</span>(<span class="dv">3</span>) <span class="sc">|&gt;</span> <span class="fu">lapply</span>(head)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
                              movie    gross       date
1 The Fantastic Four: First&amp;hellip; 14189835 2025-07-29
2                          Superman  4288442 2025-07-29
3            Jurassic World Rebirth  2369215 2025-07-29
4                            Smurfs  1416078 2025-07-29
5                          Together  1300000 2025-07-29
6                     F1: The Movie  1140072 2025-07-29

[[2]]
                              movie   gross       date
1 The Fantastic Four: First&amp;hellip; 8657354 2025-07-30
2                          Superman 2948138 2025-07-30
3                          Together 2668751 2025-07-30
4            Jurassic World Rebirth 1661935 2025-07-30
5                            Smurfs  986958 2025-07-30
6                     F1: The Movie  858496 2025-07-30

[[3]]
                              movie   gross       date
1 The Fantastic Four: First&amp;hellip; 7514899 2025-07-31
2                          Superman 2665771 2025-07-31
3                    The Bad Guys 2 2250000 2025-07-31
4                     The Naked Gun 1600000 2025-07-31
5            Jurassic World Rebirth 1543785 2025-07-31
6                          Together 1387751 2025-07-31</code></pre>
</div>
</div>
<p>Looks like we got them all. Now let’s combine them into one big data frame. <code>bind_rows()</code> takes a list of data frames, like <code>results[[1]]</code>, <code>results[[2]]</code>, …, and stacks them all on top of each other.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check that the number of rows and dates seem reasonable</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(movieData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 223063</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(movieData<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2010-01-01" "2025-07-31"</code></pre>
</div>
</div>
<p>If you ran that for-loop to gather 15 years worth of data, most likely you walked away from your computer to do something more interesting than watch its progress. In these situations, I like to send myself a text message when it is complete. The <code>emayili</code> package is a convenient way to send yourself an email or text. If you fill it in with your email, username, and gmail app password, the following code will send you an email or text message when the script reaches this point. (as of August 2025 I have not been able to get this to work)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emayili)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># https://myaccount.google.com/apppasswords</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    get a 16 character "app password"</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>smtp <span class="ot">&lt;-</span> <span class="fu">server</span>(<span class="at">host =</span> <span class="st">"smtp.gmail.com"</span>, </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">port =</span> <span class="dv">587</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">username =</span> <span class="st">"you@gmail.com"</span>,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">password =</span> <span class="st">"REPLACE WITH 16 CHARACTER APP PASSWORD"</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">starttls =</span> <span class="cn">TRUE</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">use_ssl  =</span> <span class="cn">FALSE</span>)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Verizon:  5551234567@vtext.com</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="co"># AT&amp;T:     5551234567@txt.att.net</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co"># T-Mobile: 5551234567@tmomail.net</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>email <span class="ot">&lt;-</span> <span class="fu">envelope</span>() <span class="sc">|&gt;</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>   <span class="fu">from</span>(<span class="st">"you@gmail.com"</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>   <span class="fu">to</span>(<span class="st">"5551234567@vtext.com"</span>) <span class="sc">|&gt;</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">text</span>(<span class="st">"Come back! Your movie data is ready!"</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="fu">smtp</span>(email, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the password here is in plain text so do not try this on a public computer. R also saves your history so even if it is not on the screen it might be saved somewhere else on the computer.</p>
</section>
<section id="parallel-computing" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Parallel Computing</h1>
<p>Since 1965 Moore’s Law has predicted the power of computation over time. Moore’s Law predicted the doubling of transistors about every two years. Moore’s prediction has held true for decades. However, to get that speed the transistors were made smaller and smaller. Moore’s Law cannot continue indefinitely. The diameter of a silicon atom is 0.2nm. Transistors today contain less than 70 atoms and some transistor dimensions are between 10nm and 40nm. Since 2012, computing power has not changed greatly signaling that we might be getting close to the end of Moore’s Law, at least with silicon-based computing. What has changed is the widespread use of multicore processors. Rather than having a single processor, a typical laptop might have an 8 or 16 core processor (meaning they have 8 or 16 processors that share some resources like high speed memory).</p>
<p>R can guess how many cores your computer has on hand.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doFuture)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>parallelly<span class="sc">::</span><span class="fu">availableCores</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>system 
    16 </code></pre>
</div>
</div>
<p>Having access to multiple cores allows you to write scripts that send different tasks to different processors to work on simultaneously. While one processor is busy scraping the data for January 1st, the second can get to work on January 2nd, and another can work on January 3rd. All the processors will be fighting over the one connection you have to the internet, but they can <code>grep()</code> and <code>gsub()</code> at the same time other processors are working on other dates.</p>
<p>To write a script to work in parallel, you will need the <code>foreach</code> and <code>future</code> packages. Let’s first test whether parallelization actually speed things up. There are two <code>foreach</code> loops below. In both of them, each iteration of the loop does not really do anything except pause for 2 seconds. The first loop, which does not use parallelization, includes 10 iterations and so should take 20 seconds to run. The second <code>foreach</code> loop looks the same, except right before the <code>foreach</code> loop we have told R to make use of two of the computer’s processors rather than the default of one processor. This should cause one processor to sleep for 2 seconds 10 times and the other processor to sleep for 2 seconds 10 times. In total this should take about 10 seconds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co"># should take 10*2=20 seconds</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>( <span class="co"># time how long this takes</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%do%</span> <span class="co"># not in parallel</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">Sys.sleep</span>(<span class="dv">2</span>)  <span class="co"># wait for 2 seconds</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(i)</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
   0.04    0.00   20.45 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set up R to use 2 cores</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">2</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co"># tells %dopar% to use the plan's 2 cores</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># with two processors should take about 10 seconds</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">foreach</span>(<span class="at">i=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>) <span class="sc">%dopar%</span> <span class="co"># run in parallel</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">2</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(i)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
   0.14    0.00   10.55 </code></pre>
</div>
</div>
<p>Sure enough, the parallel implementation was able to complete 20 seconds worth of sleeping in about 10 seconds. To set up code to run in parallel, the key steps are to set up the cores using <code>plan()</code> and to tell parallel <code>foreach()</code> to use that cluster of processors with <code>registerDoFuture()</code>. Note that the key difference between the two <code>foreach()</code> statements is that the first <code>foreach()</code> is followed by a <code>%do%</code> while the second is followed by a <code>%dopar%</code>. When <code>foreach()</code> sees the <code>%dopar%</code> it will check what was set up in the <code>registerDoFuture()</code> call and spread the computation among those cores.</p>
<p>Note that the <code>foreach()</code> differs a little bit in its syntax compared with our previous use of for-loops. While for-loops have the syntax <code>for(i in 1:10)</code> the syntax for <code>foreach()</code> looks like <code>foreach(i=1:10)</code> and is followed by a <code>%do%</code> or a <code>%dopar%</code>. Lastly, note that the final step inside the <code>{ }</code> following a <code>foreach()</code> is a <code>return()</code> statement. <code>foreach()</code> will take the returned values of each of the iterations and assemble them into a single list by default. In the following <code>foreach()</code> we have added <code>.combine=bind_rows</code> to the <code>foreach()</code> so that the final results will be stacked into one data frame, avoiding the need for a separate <code>bind_rows()</code> like we used previously.</p>
<p>Parallelization introduces some complications. If anything goes wrong in a parallelized script, then the whole <code>foreach()</code> fails. For example, let’s say that after scraping movie data from 2000-2016 you briefly lose your internet connection. If this happens, then <code>scan()</code> fails and the whole <code>foreach()</code> will end with an error, tossing all of your already complete computation. To avoid this you need to either be sure you have a solid internet connection, or wrap the call to <code>scan()</code> in a <code>try()</code> and a <code>repeat</code> loop that is smart enough to wait a few seconds and try the scan again rather than fail completely.</p>
<p>With all this in mind, let’s web scrape the movie data using multiple cores with a <code>try()</code>/<code>repeat</code>. Typically, any attempts to print from inside a parallel <code>foreach()</code> do not appear in the console, since that print is running in a separate, parallel R session. The <code>progressr</code> package offers a way to print a progress bar to the console that also offers an estimated time to completion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(progressr)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">8</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoFuture</span>()</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># setup a Command-Line Interface progress bar</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">handlers</span>(<span class="st">"cli"</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>timeStart <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>() <span class="co"># record the starting time</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="co"># wrap the foreach inside the progress monitor</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>movieData <span class="ot">&lt;-</span> <span class="fu">with_progress</span>(</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>   <span class="co"># create a progress bar how many total steps in the foreach loop</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>   p <span class="ot">&lt;-</span> <span class="fu">progressor</span>(<span class="at">steps =</span> <span class="fu">length</span>(dates2scrape))</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>   result <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">iDate=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(dates2scrape),</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">.combine =</span> dplyr<span class="sc">::</span>bind_rows) <span class="sc">%dopar%</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>   {</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># update progress bar</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">p</span>(<span class="fu">paste</span>(<span class="st">"Working on"</span>, dates2scrape[iDate]))</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>      urlText <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"https://www.the-numbers.com/box-office-chart/daily/"</span>,</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">gsub</span>(<span class="st">"-"</span>, <span class="st">"/"</span>, dates2scrape[iDate]))</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>      <span class="co"># retry up to 5 times with short backoff</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>      tries <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">repeat</span> </span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>         tries <span class="ot">&lt;-</span> tries <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>         a <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">scan</span>(urlText, <span class="at">what =</span> <span class="st">""</span>, <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fileEncoding =</span> <span class="st">"UTF-8"</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>), </span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>                  <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span>(<span class="sc">!</span><span class="fu">inherits</span>(a, <span class="st">"try-error"</span>) <span class="sc">||</span> tries <span class="sc">&gt;=</span> <span class="dv">5</span>) <span class="cf">break</span></span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>         <span class="fu">Sys.sleep</span>(<span class="dv">10</span>)</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>      <span class="co"># skip this date on persistent failure</span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">inherits</span>(a, <span class="st">"try-error"</span>)) <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>      i <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"#tab=box-office"</span>, a)</span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>      data0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">movie =</span> <span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;"</span>, <span class="st">""</span>, a[i]),</span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>                          <span class="at">gross =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;|[$,]"</span>,<span class="st">""</span>,a[i<span class="sc">+</span><span class="dv">2</span>])),</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a>                          <span class="at">date  =</span> dates2scrape[iDate])</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>     <span class="fu">return</span>(data0)</span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>   <span class="co"># the last object in with_progress() will be returned</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>   result</span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate how long it took</span></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>timeEnd <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>timeEnd<span class="sc">-</span>timeStart</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This code made use of 8 processors. Unlike our 2 second sleep example, this script may not be exactly 8 times faster. Each processor still needs to wait its turn in order to pull down its webpage from the internet. However, you should observe the parallel version finishing much sooner than the first version. In just a few lines of code and about 10 minutes of waiting, you now have 15 years worth of movie data.</p>
<p>Before moving on, let’s do a final check that everything looks okay.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(movieData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 223063</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(movieData<span class="sc">$</span>date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "2010-01-01" "2025-07-31"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(movieData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                              movie    gross       date
1                            Avatar 25274008 2010-01-01
2                   Sherlock Holmes 14889882 2010-01-01
3 Alvin and the Chipmunks: &amp;hellip; 12998264 2010-01-01
4                  It’s Complicated  7127425 2010-01-01
5                    The Blind Side  4554779 2010-01-01
6                     Up in the Air  4112263 2010-01-01</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span>(movieData)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                   movie gross       date
223058                          Shoshana  4793 2025-07-31
223059                               Ran  1878 2025-07-31
223060       Jane Austen Wrecked My Life  1132 2025-07-31
223061 Jujutsu Kaisen: Hidden In&amp;hellip;  1019 2025-07-31
223062 Hearts of Darkness: A Fil&amp;hellip;   997 2025-07-31
223063                         Sovereign   156 2025-07-31</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check for movie names with HTML codes</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>movieData<span class="sc">$</span>movie <span class="sc">|&gt;</span> <span class="fu">grep</span>(<span class="st">"&amp;[A-z]+;"</span>, <span class="at">x=</span>_, <span class="at">value=</span><span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="fu">unique</span>() <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Alvin and the Chipmunks: &amp;hellip;" "Did You Hear About the Mo&amp;hellip;"
[3] "Precious (Based on the No&amp;hellip;" "Cloudy with a Chance of M&amp;hellip;"
[5] "The Boondock Saints 2: Al&amp;hellip;" "The Imaginarium of Doctor&amp;hellip;"</code></pre>
</div>
</div>
<p>Those HTML characters in movie titles are annoying to look at. Let’s fix it now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># change HTML codes to something prettier</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>movieData <span class="ot">&lt;-</span> movieData <span class="sc">|&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">movie =</span> <span class="fu">gsub</span>(<span class="st">"&amp;hellip;"</span>, <span class="st">"..."</span>, movie))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s probably wise at this point to save <code>movieData</code> so that you won’t have to rerun this in the future.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(movieData, <span class="at">file=</span><span class="st">"movieData.RData"</span>, <span class="at">compress=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fun-with-movie-data" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Fun With Movie Data</h1>
<p>You can use the dataset to answer questions such as “which movie yielded the largest gross?”</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span> <span class="fu">slice_max</span>(gross)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              movie     gross       date
1 Avengers: Endgame 157461641 2019-04-26</code></pre>
</div>
</div>
<p>Which ten movies had the largest total gross during the period this dataset covers?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarize</span>(<span class="at">gross=</span><span class="fu">sum</span>(gross), <span class="at">.by=</span>movie) <span class="sc">|&gt;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_max</span>(gross, <span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          movie     gross
1  Star Wars Ep. VII: The Fo... 992642689
2             Avengers: Endgame 918373000
3       Spider-Man: No Way Home 854793477
4  Guardians of the Galaxy V... 783308916
5  Harry Potter and the Deat... 743512289
6             Top Gun: Maverick 738032821
7                 Black Panther 725259566
8        Avengers: Infinity War 717815482
9      Avatar: The Way of Water 701075767
10         Deadpool &amp; Wolverine 675245858</code></pre>
</div>
</div>
<p>Which days of the week yielded the largest total gross?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">weekday=</span><span class="fu">wday</span>(date, <span class="at">label=</span><span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarize</span>(<span class="at">gross=</span><span class="fu">sum</span>(gross), <span class="at">.by=</span>weekday) <span class="sc">|&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(gross))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  weekday       gross
1     Sat 39105939612
2     Fri 33286361375
3     Sun 27384146823
4     Thu 12532078590
5     Tue 12208580533
6     Mon 11613053523
7     Wed 10204176207</code></pre>
</div>
</div>
<section id="inflation-adjust" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="inflation-adjust"><span class="header-section-number">5.1</span> Inflation adjust</h2>
<p>As you may have noticed, the price of going to see a movie keeps increasing. the-numbers.com keeps track of the average movie ticket price, which we can use to create a movie-specific inflation factor. Let’s scrape the average ticket price from <a href="https://www.the-numbers.com/market/">https://www.the-numbers.com/market/</a> and compute an inflation adjustment factor. That factor will vary by year. It will tell you how much you need to multiply, say, a ticket purchased in 2010 so that it equates to 2025 prices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">scan</span>(<span class="st">"https://www.the-numbers.com/market/"</span>,</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>          <span class="at">what=</span><span class="st">""</span>, <span class="at">sep=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Ticket Price|Number of Wide Releases"</span>, a)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> a[i[<span class="dv">1</span>]<span class="sc">:</span>i[<span class="dv">2</span>]]</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"market"</span>,a)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>inflation <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">year =</span> <span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;"</span>,<span class="st">""</span>,a[i]),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">avgPrice =</span> <span class="fu">gsub</span>(<span class="st">"&lt;[^&gt;]*&gt;|</span><span class="sc">\\</span><span class="st">$"</span>,<span class="st">""</span>,a[i<span class="sc">+</span><span class="dv">4</span>])) <span class="sc">|&gt;</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(year),</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">avgPrice =</span> <span class="fu">as.numeric</span>(avgPrice),</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">adjustment =</span> avgPrice[<span class="dv">1</span>]<span class="sc">/</span>avgPrice) <span class="sc">|&gt;</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2010</span>)</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>inflation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   year avgPrice adjustment
1  2025    11.31   1.000000
2  2024    11.31   1.000000
3  2023    10.94   1.033821
4  2022    10.53   1.074074
5  2021    10.17   1.112094
6  2020     9.18   1.232026
7  2019     9.16   1.234716
8  2018     9.11   1.241493
9  2017     8.97   1.260870
10 2016     8.65   1.307514
11 2015     8.43   1.341637
12 2014     8.17   1.384333
13 2013     8.13   1.391144
14 2012     7.96   1.420854
15 2011     7.93   1.426230
16 2010     7.89   1.433460</code></pre>
</div>
</div>
<p>Now we link each movie to our inflation factor table to compute ticket sales adjusted to 2025 prices.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="ot">&lt;-</span> movieData <span class="sc">|&gt;</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year=</span><span class="fu">year</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(inflation, <span class="fu">join_by</span>(year<span class="sc">==</span>year)) <span class="sc">|&gt;</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">grossAdj=</span>gross<span class="sc">*</span>adjustment) <span class="sc">|&gt;</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span>avgPrice, <span class="sc">-</span>adjustment)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">grossAdj=</span><span class="fu">sum</span>(grossAdj), <span class="at">.by=</span>movie) <span class="sc">|&gt;</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(grossAdj, <span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          movie   grossAdj
1  Star Wars Ep. VII: The Fo... 1322086438
2             Avengers: Endgame 1133929981
3  Harry Potter and the Deat... 1062618923
4       Spider-Man: No Way Home  941797593
5                  The Avengers  906147264
6  The Twilight Saga: Breaki...  902658283
7  Guardians of the Galaxy V...  902167478
8                 Black Panther  900404576
9                Jurassic World  899833273
10       Avengers: Infinity War  891162799</code></pre>
</div>
</div>
<p><em>Twilight</em> joins the top 10 list. However, <em>Twilight</em> and <em>Potter</em> fans in previous classes have pointed out that <em>Twilight: Breaking Dawn</em> and <em>Harry Potter and the Deathly Hallows</em> were broken up into two movies. Because the-numbers.com truncates the movie titles with …, R has lumped Part 1 and Part 2 together for both of these movies. Sure, we could look up when those open nights were, but let’s try using the data instead.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(movie<span class="sc">==</span><span class="st">"Harry Potter and the Deat..."</span>) <span class="sc">|&gt;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">gross =</span> <span class="fu">sum</span>(gross)<span class="sc">/</span><span class="dv">1000000</span>,  <span class="co"># gross in millions</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">.by =</span> date) <span class="sc">|&gt;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(gross<span class="sc">~</span>date, <span class="at">data=</span>_,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab=</span><span class="st">"Date"</span>, <span class="at">ylab=</span><span class="st">"Gross (millions of dollars)"</span>)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">ymd</span>(<span class="fu">c</span>(<span class="st">"2010-11-19"</span>, <span class="st">"2011-07-15"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="09_Webscraping_and_Parallel_Processing_files/figure-html/unnamed-chunk-33-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Daily gross for <em>Harry Potter and the Deathly Hallows</em></figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(movie<span class="sc">==</span><span class="st">"The Twilight Saga: Breaki..."</span>) <span class="sc">|&gt;</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">gross =</span> <span class="fu">sum</span>(gross)<span class="sc">/</span><span class="dv">1000000</span>, <span class="at">.by =</span> date) <span class="sc">|&gt;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(gross<span class="sc">~</span>date, <span class="at">data=</span>_,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">xlab=</span><span class="st">"Date"</span>, <span class="at">ylab=</span><span class="st">"Gross (millions of dollars)"</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="fu">ymd</span>(<span class="fu">c</span>(<span class="st">"2011-11-18"</span>, <span class="st">"2012-11-16"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="09_Webscraping_and_Parallel_Processing_files/figure-html/unnamed-chunk-34-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Daily gross for <em>The Twilight Saga: Breaking Dawn</em></figcaption>
</figure>
</div>
</div>
</div>
<p>In both of these figures we see the enormous ticket sales in the first several days followed by a steady decline over the subsequent months. Then, another large spike in ticket sales indicating a second installment. When we find a large spike in ticket sales, we will mark that as indicating the second part.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>part2date <span class="ot">&lt;-</span> movieData <span class="sc">|&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(movie <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Harry Potter and the Deat..."</span>,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"The Twilight Saga: Breaki..."</span>)) <span class="sc">|&gt;</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarize</span>(<span class="at">gross =</span> <span class="fu">sum</span>(gross), <span class="co"># total sales by date and movie</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">.by=</span><span class="fu">c</span>(movie, date)) <span class="sc">|&gt;</span> </span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(movie) <span class="sc">|&gt;</span> <span class="co"># now find large change within movie</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(movie, date) <span class="sc">|&gt;</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">change =</span> gross <span class="sc">-</span> <span class="fu">lag</span>(gross)) <span class="sc">|&gt;</span> <span class="co"># lag is NA for 1st one</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>   <span class="co"># find the two largest jumps in sales</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>   <span class="co">#    one is likely Part 1 and another Part 2</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_max</span>(change, <span class="at">n=</span><span class="dv">2</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>   <span class="co">#    one with later date is Part 2</span></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_max</span>(date) <span class="sc">|&gt;</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>   <span class="fu">rename</span>(<span class="at">date2 =</span> date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before altering <code>movieData</code>, let’s make sure we get this join right.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># test the merge</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(part2date <span class="sc">|&gt;</span> <span class="fu">select</span>(movie, date2), </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(movie <span class="sc">==</span> movie)) <span class="sc">|&gt;</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">moviePart =</span> </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>             <span class="fu">case_when</span>(</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                <span class="co"># use three days before Part 2 as cutoff</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!</span><span class="fu">is.na</span>(date2) <span class="sc">&amp;</span> date <span class="sc">&lt;</span> date2 <span class="sc">-</span> <span class="fu">ddays</span>(<span class="dv">3</span>) <span class="sc">~</span> <span class="st">"Part 1"</span>,</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!</span><span class="fu">is.na</span>(date2) <span class="sc">&amp;</span> date <span class="sc">&gt;</span> date2 <span class="sc">-</span> <span class="fu">ddays</span>(<span class="dv">3</span>) <span class="sc">~</span> <span class="st">"Part 2"</span>,</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>                <span class="at">.default =</span> <span class="st">""</span>)) <span class="sc">|&gt;</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(movie <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Harry Potter and the Deat..."</span>,</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"The Twilight Saga: Breaki..."</span>)) <span class="sc">|&gt;</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(movie, gross, date, moviePart) <span class="sc">|&gt;</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(movie, moviePart) <span class="sc">|&gt;</span> </span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   movie, moviePart [4]
  movie                           gross date       moviePart
  &lt;chr&gt;                           &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt;    
1 Harry Potter and the Deat... 24000000 2010-11-18 Part 1   
2 Harry Potter and the Deat... 43500000 2011-07-14 Part 2   
3 The Twilight Saga: Breaki... 30250000 2011-11-17 Part 1   
4 The Twilight Saga: Breaki... 30400000 2012-11-15 Part 2   </code></pre>
</div>
</div>
<p>Great! Looks like the <code>moviePart</code> has the right values given the dates. Now we can paste the Part 1 and Part 2 on the end of the movie name.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="ot">&lt;-</span> movieData <span class="sc">|&gt;</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(part2date <span class="sc">|&gt;</span> <span class="fu">select</span>(movie, date2), </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(movie <span class="sc">==</span> movie)) <span class="sc">|&gt;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">moviePart =</span> </span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">case_when</span>(</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>                <span class="co"># use three days before Part 2 as cutoff</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!</span><span class="fu">is.na</span>(date2) <span class="sc">&amp;</span> date <span class="sc">&lt;</span> date2 <span class="sc">-</span> <span class="fu">ddays</span>(<span class="dv">3</span>) <span class="sc">~</span> <span class="st">"Part 1"</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!</span><span class="fu">is.na</span>(date2) <span class="sc">&amp;</span> date <span class="sc">&gt;</span> date2 <span class="sc">-</span> <span class="fu">ddays</span>(<span class="dv">3</span>) <span class="sc">~</span> <span class="st">"Part 2"</span>,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>                <span class="at">.default =</span> <span class="st">""</span>),</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">movie =</span> <span class="fu">paste0</span>(movie, moviePart)) <span class="sc">|&gt;</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span>date2, <span class="sc">-</span>moviePart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can redo our list of top 10 movies by inflation-adjusted gross. No Harry Potter or Twilight anymore.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">grossAdj=</span><span class="fu">sum</span>(grossAdj), <span class="at">.by=</span>movie) <span class="sc">|&gt;</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(grossAdj, <span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                          movie   grossAdj
1  Star Wars Ep. VII: The Fo... 1322086438
2             Avengers: Endgame 1133929981
3       Spider-Man: No Way Home  941797593
4                  The Avengers  906147264
5  Guardians of the Galaxy V...  902167478
6                 Black Panther  900404576
7                Jurassic World  899833273
8        Avengers: Infinity War  891162799
9  The Hunger Games: Mocking...  888246195
10 Star Wars Ep. VIII: The L...  836711876</code></pre>
</div>
</div>
<p>They have moved far down the list of highest grossing movies.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarize</span>(<span class="at">grossAdj=</span><span class="fu">sum</span>(grossAdj), <span class="at">.by=</span>movie) <span class="sc">|&gt;</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">rank =</span> <span class="fu">rank</span>(<span class="sc">-</span>grossAdj)) <span class="sc">|&gt;</span> <span class="co"># ranks so 1 is largest grossAdj</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"Harry Potter and the Deat...|The Twilight Saga: Breaki..."</span>,</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>                movie))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               movie  grossAdj rank
1 Harry Potter and the Deat...Part 1 457168496   61
2 Harry Potter and the Deat...Part 2 605450427   27
3 The Twilight Saga: Breaki...Part 1 444288808   67
4 The Twilight Saga: Breaki...Part 2 458369475   59</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>movieJumps <span class="ot">&lt;-</span> movieData <span class="sc">|&gt;</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarise</span>(<span class="at">gross =</span> <span class="fu">sum</span>(gross), <span class="at">.by =</span> <span class="fu">c</span>(movie, date)) <span class="sc">|&gt;</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(movie, date) <span class="sc">|&gt;</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(movie) <span class="sc">|&gt;</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">prev_gross  =</span> <span class="fu">lag</span>(gross),</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">change      =</span> gross <span class="sc">-</span> prev_gross,</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">pct_change  =</span> <span class="dv">100</span><span class="sc">*</span>change <span class="sc">/</span> <span class="fu">pmax</span>(prev_gross, <span class="dv">1</span>)) <span class="sc">|&gt;</span>  <span class="co"># guard div-by-zero</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(change), change <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>movieJumps <span class="sc">|&gt;</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(movie) <span class="sc">|&gt;</span></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(change, <span class="at">n=</span><span class="dv">2</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">first_date   =</span> <span class="fu">min</span>(date),</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">second_date  =</span> <span class="fu">max</span>(date),</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">sep_days     =</span> <span class="fu">as.integer</span>(<span class="fu">diff</span>(<span class="fu">range</span>(date))),</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_top2_pct =</span> <span class="fu">min</span>(pct_change),</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">min_top2_abs =</span> <span class="fu">min</span>(change)) <span class="sc">|&gt;</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(sep_days     <span class="sc">&gt;=</span> <span class="dv">30</span>,         <span class="co"># spikes 30+ days apart</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>          min_top2_pct <span class="sc">&gt;=</span> <span class="dv">100</span>,        <span class="co"># jump at least 100%</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>          min_top2_abs <span class="sc">&gt;=</span> <span class="dv">1000000</span>) <span class="sc">|&gt;</span> <span class="co"># jump at least $5m</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(min_top2_pct))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 6
   movie               first_date second_date sep_days min_top2_pct min_top2_abs
   &lt;chr&gt;               &lt;date&gt;     &lt;date&gt;         &lt;int&gt;        &lt;dbl&gt;        &lt;dbl&gt;
 1 Paranormal Activit… 2014-01-03 2015-10-23       658         450.      2702140
 2 DC League of Super… 2022-07-29 2022-09-03        36         246.      1809039
 3 The Hunger Games: … 2014-11-21 2015-11-20       364         185.     29579056
 4 Guardians of the G… 2017-05-05 2023-05-05      2191         175.     30603839
 5 Coraline            2023-08-14 2024-08-15       367         166.      1387224
 6 Teenage Mutant Nin… 2016-06-03 2023-08-02      2616         165.      6352275
 7 The Descendants     2011-11-25 2012-01-27        63         156.      1447375
 8 Pirates of the Car… 2011-05-27 2017-05-26      2191         141.      6385756
 9 Robin Hood          2010-05-21 2018-11-21      3106         138.      3146644
10 Alvin and the Chip… 2010-01-09 2011-12-16       706         132.      4581172
11 The Lord of the Ri… 2024-06-08 2024-12-13       188         109.      1280660</code></pre>
</div>
</div>
<p>Looks like several more movies need parts added to them. <em>The Hunger Games: Mockingjay</em> had two parts. <em>Guardians of the Galaxy</em> had Volume 1, 2, and 3 (first one was simply <em>Guardians of the Galaxy</em>). <em>Teenage Mutant Ninja Turtles</em> was released in 2014, <em>Teenage Mutant Ninja Turtles: Out of the Shadows</em> was released in 2016, and <em>Teenage Mutant Ninja Turtles: Mutant Mayhem</em> was released in 2023 (more planned for 2027!). There have been five <em>Pirates of the Caribbean</em> movies, two of which were released after 2010. Robin Hood is two different movies with the same title, one starring Russell Crowe and another starring Taron Egerton. A few on here are anomolies that we can safely ignore like <em>Coraline</em>, <em>The Descendants</em>, the anime film <em>The Lord of the Rings: The War of the Rohirrim</em>, and the <em>DC League of Super Pets</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>partDates <span class="ot">&lt;-</span> movieData <span class="sc">|&gt;</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(movie <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Paranormal Activity: The ..."</span>,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"The Hunger Games: Mocking..."</span>,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Guardians of the Galaxy V..."</span>,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Teenage Mutant Ninja Turt..."</span>,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Pirates of the Caribbean:..."</span>,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Alvin and the Chipmunks: ..."</span>)) <span class="sc">|&gt;</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">summarize</span>(<span class="at">gross =</span> <span class="fu">sum</span>(gross),</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">.by=</span><span class="fu">c</span>(movie, date)) <span class="sc">|&gt;</span> </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(movie) <span class="sc">|&gt;</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(movie, date) <span class="sc">|&gt;</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">change =</span> gross <span class="sc">-</span> <span class="fu">lag</span>(gross)) <span class="sc">|&gt;</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_max</span>(change, <span class="at">n=</span><span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(movie, date) <span class="sc">|&gt;</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">daysDiff =</span> <span class="fu">as.numeric</span>(date<span class="sc">-</span><span class="fu">lag</span>(date))) <span class="sc">|&gt;</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">is.na</span>(daysDiff) <span class="sc">|</span> (daysDiff<span class="sc">&gt;</span><span class="dv">30</span>)) <span class="sc">|&gt;</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">start =</span> date<span class="sc">-</span><span class="fu">ddays</span>(<span class="dv">3</span>),</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">end =</span> <span class="fu">lead</span>(date, <span class="at">default =</span> <span class="fu">ymd</span>(<span class="st">"2100-01-01"</span>))<span class="sc">-</span><span class="fu">ddays</span>(<span class="dv">3</span>),</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Alvin opened in December 2009</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">start =</span> <span class="fu">if_else</span>(movie<span class="sc">==</span><span class="st">"Alvin and the Chipmunks: ..."</span> <span class="sc">&amp;</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>                             date<span class="sc">==</span><span class="st">"2010-01-09"</span>,</span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">ymd</span>(<span class="st">"2010-01-01"</span>),</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>                          start))</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>partDates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 8
   movie           date        gross change daysDiff start      end         year
   &lt;chr&gt;           &lt;date&gt;      &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;date&gt;     &lt;date&gt;     &lt;dbl&gt;
 1 Alvin and the … 2010-01-09 8.05e6 4.58e6       NA 2010-01-01 2011-12-13  2010
 2 Alvin and the … 2011-12-16 6.71e6 6.70e6      706 2011-12-13 2015-12-15  2011
 3 Alvin and the … 2015-12-18 4.13e6 4.12e6     1463 2015-12-15 2099-12-29  2015
 4 Guardians of t… 2017-05-05 5.61e7 3.91e7       NA 2017-05-02 2023-05-01  2017
 5 Guardians of t… 2023-05-04 1.75e7 1.75e7     2190 2023-05-01 2099-12-29  2023
 6 Paranormal Act… 2014-01-03 8.72e6 7.52e6       NA 2013-12-31 2015-10-20  2014
 7 Paranormal Act… 2015-10-23 3.30e6 2.70e6      651 2015-10-20 2099-12-29  2015
 8 Pirates of the… 2011-05-27 1.09e7 6.39e6       NA 2011-05-24 2017-05-22  2011
 9 Pirates of the… 2017-05-25 5.50e6 5.44e6     2190 2017-05-22 2099-12-29  2017
10 Teenage Mutant… 2016-06-03 1.25e7 1.05e7       NA 2016-05-31 2023-07-30  2016
11 Teenage Mutant… 2023-08-02 1.02e7 6.35e6     2616 2023-07-30 2099-12-29  2023
12 The Hunger Gam… 2014-11-21 5.51e7 3.81e7       NA 2014-11-18 2015-11-16  2014
13 The Hunger Gam… 2015-11-19 1.6 e7 1.60e7      363 2015-11-16 2099-12-29  2015</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>movieData <span class="ot">&lt;-</span> movieData <span class="sc">|&gt;</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span>year) <span class="sc">|&gt;</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(partDates <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>date, <span class="sc">-</span>gross, <span class="sc">-</span>change, <span class="sc">-</span>daysDiff), </span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(movie,</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>                     date <span class="sc">&gt;=</span>start,</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>                     date <span class="sc">&lt;</span> end)) <span class="sc">|&gt;</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">moviePart =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(year), </span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">paste0</span>(<span class="st">"("</span>,year,<span class="st">")"</span>),</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>                              <span class="st">""</span>),</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">movie =</span> <span class="fu">paste0</span>(movie, moviePart)) <span class="sc">|&gt;</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span>start, <span class="sc">-</span>end, <span class="sc">-</span>year, <span class="sc">-</span>moviePart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>movieData <span class="sc">|&gt;</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">str_starts</span>(movie, <span class="st">"Alvin and the Chipmunks"</span>) <span class="sc">|</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>          <span class="fu">str_starts</span>(movie, <span class="st">"Guardians of the Galaxy"</span>) <span class="sc">|</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">str_starts</span>(movie, <span class="st">"The Hunger Games: Mocking"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(movie, year) <span class="sc">|&gt;</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                movie year
1  Alvin and the Chipmunks: ...(2010) 2010
2  Alvin and the Chipmunks: ...(2011) 2011
3  Alvin and the Chipmunks: ...(2011) 2012
4             Guardians of the Galaxy 2014
5  The Hunger Games: Mocking...(2014) 2014
6  The Hunger Games: Mocking...(2014) 2015
7  The Hunger Games: Mocking...(2015) 2015
8  Alvin and the Chipmunks: ...(2015) 2015
9  Alvin and the Chipmunks: ...(2015) 2016
10 The Hunger Games: Mocking...(2015) 2016
11 Guardians of the Galaxy V...(2017) 2017
12            Guardians of the Galaxy 2020
13 Guardians of the Galaxy V...(2023) 2023</code></pre>
</div>
</div>
<p>Let’s save our final movie dataset with inflation-adjusted gross and corrected movie titles.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(movieData, <span class="at">file=</span><span class="st">"movieData2.RData"</span>, <span class="at">compress=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that you have movie data and in a previous section you assembled Chicago crime data, combine the two datasets so that you can answer the question “what happens to crime when big movies come out?”</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>